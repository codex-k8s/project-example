# Архитектура проекта

Цель: предсказуемое развитие системы.
- Бизнес-логика изолирована от инфраструктуры/транспортов.
- Сервисы слабо связаны; изменения локализуются в домене.
- Контракты (API/события) типизированы, версионируемы, генерируются из единого источника.
- Эксплуатация (деплой/наблюдаемость/конфиг) стандартизирована.

База: DDD (bounded contexts) + Clean Architecture (зависимости “снаружи внутрь”) + единый инвентарь деплоя (`services.yaml`) + единый каркас директорий.

## Микросервисы и монорепозиторий

Правила:
- Сервис = единица деплоя/масштабирования; нельзя “склеивать” разные домены ради удобства.
- Взаимодействие: gRPC (внутри) / RabbitMQ (async) / HTTP(внешнее, обычно через gateway/BFF) / WebSocket (real-time по необходимости).
- Shared DB между сервисами — исключение (предпочитайте API/события).
- Общие контракты — из `proto/` (single source of truth) + генерация; никаких “скопированных структур” по сервисам.

## Структура репозитория

Верхний уровень (смысл):
- `services.yaml` — инвентарь того, что деплоится/как настраивается по окружениям. Деплоится с использованием `github.com/codex-k8s/codexctl`.
- `services/` — все сервисы по зонам (`internal|external|staff|jobs|dev`).
- `libs/` — переиспользуемый код (по языкам/назначению).
- `proto/` — единый источник правды контрактов + генерация + проверки совместимости.
- `deploy/` — общая инфраструктура/манифесты.
- `docs/` — документация.
- `scripts/` — утилиты/генерация/CI helpers.
- `.github/` — CI/CD.

Соглашения:
- Имена сервисов/директорий — `kebab-case`.
- Один сервис = `services/<zone>/<service-name>/`.
- Снаружи все сервисы выглядят одинаково (единый каркас).

## Зоны сервисов: internal / external / staff / jobs / dev

Зона определяет доступ и набор обязательных требований.

### `services/internal/`
Правила:
- Только внутренние сервисы; без публичного ingress.
- Основной транспорт: gRPC + очередь; HTTP — только тех. эндпоинты (health/metrics).
- Доступ ограничивать сетевыми политиками/mesh.

### `services/external/`
Правила:
- Публичные API (gateway/BFF/edge).
- Обязательно: authn/authz + rate limiting + аудит.
- Типичные транспорты: HTTP/REST, WebSocket; внутрь — gRPC.

### `services/staff/`
Правила:
- Сервисы для сотрудников (VPN/SSO/IP allowlist и т.п.).
- Обязательно: аудит действий; отдельные роли/права; отдельные маршруты/домены.

### `services/jobs/`
Правила:
- Фоновые задачи (CronJob/worker/consumer).
- Обязательно: идемпотентность + корректные ретраи; health/metrics есть, но не публично.

### `services/dev/`
Правила:
- Только для разработки; не деплоятся в staging/prod; должны быть явно выключены через `services.yaml`. Используются в dev/AI-dev, например `dev-grpc-gateway` - доступ к grpc через `Swagger/OpenAPI`.

## Границы сервисов и разделение ответственности

Правила:
- Один сервис = один bounded context и одна “причина для изменения”.
- Запрещено: “service-олигарх”, который знает обо всём.
- Данные: сервис владеет своими данными; доступ другим — через API/события, не через прямой SQL.

Как выделять сервис:
- По бизнес-терминам/процессам (не по таблицам/технологиям).
- Если части меняются независимо/масштабируются отдельно — разделяйте.

Запрещено:
- Доменная логика в edge-сервисах (external/staff должны быть thin-edge).
- Дублировать “общие утилиты” в каждом сервисе вместо `libs/`.
- Общие таблицы/схемы БД без явного владельца.
