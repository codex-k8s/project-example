# Архитектура проекта

Цель: предсказуемое развитие системы.
- Бизнес-логика изолирована от инфраструктуры/транспортов.
- Сервисы слабо связаны; изменения локализуются в домене.
- Транспортные контракты (gRPC/HTTP/events) типизированы и версионируемы; доменные модели живут отдельно от транспорта и маппятся на границе.
- Эксплуатация (деплой/наблюдаемость/конфиг) стандартизирована.

База: DDD (bounded contexts) + Clean Architecture (зависимости “снаружи внутрь”) + единый инвентарь деплоя (`services.yaml`) + единый каркас директорий.

## Микросервисы и монорепозиторий

Правила:
- Сервис = единица деплоя/масштабирования; нельзя “склеивать” разные домены ради удобства.
- Взаимодействие: gRPC (внутри) / RabbitMQ (async) / HTTP(внешнее, обычно через gateway/BFF) / WebSocket (real-time по необходимости).
- Shared DB между сервисами — исключение (предпочитайте API/события).
- gRPC-контракты — из `proto/` (single source of truth) + генерация; домен не равен proto и не “копируется” из него.

## Структура репозитория

Верхний уровень (смысл):
- `services.yaml` — инвентарь того, что деплоится/как настраивается по окружениям. Деплоится с использованием `github.com/codex-k8s/codexctl`.
- `services/` — все сервисы по зонам (`internal|external|staff|jobs|dev`).
- `libs/` — переиспользуемый код (по языкам/назначению).
- `proto/` — единый источник правды **gRPC** контрактов + генерация + проверки совместимости.
- `deploy/` — общая инфраструктура/манифесты.
- `docs/` — документация.
- `scripts/` — утилиты/генерация/CI helpers.
- `.github/` — CI/CD.

Соглашения:
- Имена сервисов/директорий — `kebab-case`.
- Один сервис = `services/<zone>/<service-name>/`.
- Снаружи все сервисы выглядят одинаково (единый каркас).

## Зоны сервисов: internal / external / staff / jobs / dev

Зона определяет доступ и набор обязательных требований.

### `services/internal/`
Правила:
- Только внутренние сервисы; без публичного ingress.
- Основной транспорт: gRPC + очередь; HTTP — только тех. эндпоинты (health/metrics).
- Доступ ограничивать сетевыми политиками/mesh.

### `services/external/`
Правила:
- Публичные API (gateway/BFF/edge).
- Обязательно: authn/authz + rate limiting + аудит.
- Типичные транспорты: HTTP/REST, WebSocket; внутрь — gRPC.
- HTTP API описывается OpenAPI (для Go-сервисов валидация через `github.com/getkin/kin-openapi`).
- UI/клиентские приложения для внешних пользователей (frontend) живут здесь.

### `services/staff/`
Правила:
- Сервисы для сотрудников (VPN/SSO/IP allowlist и т.п.).
- Обязательно: аудит действий; отдельные роли/права; отдельные маршруты/домены.
- UI/приложения для сотрудников живут здесь.

### `services/jobs/`
Правила:
- Фоновые задачи (CronJob/worker/consumer).
- Обязательно: идемпотентность + корректные ретраи; health/metrics есть, но не публично.

### `services/dev/`
Правила:
- Только для разработки; не деплоятся в staging/prod; должны быть явно выключены через `services.yaml`.

## Матрица размещения (что куда класть)

| Артефакт | Где живёт | Примечания |
|---|---|---|
| Go доменный сервис (core) | `services/internal/*` | Внутренний gRPC/queue; без публичного ingress. |
| Go edge/BFF/gateway | `services/external/*` или `services/staff/*` | Внешний HTTP/WS; внутрь — gRPC. |
| Frontend (public) | `services/external/*` | Vue 3 + TS + Pinia + Axios + Vite(+PWA) + i18n/router/cookies. |
| Frontend (staff/admin) | `services/staff/*` | То же, но для сотрудников/админки. |
| Jobs/воркеры/cron | `services/jobs/*` | Без публичного API; идемпотентность и ретраи обязательны. |
| Dev-only сервисы/утилиты | `services/dev/*` | Только dev; должны быть выключены в staging/prod через `services.yaml`. |
| Go доменные модели/порты | `services/*/*/internal/domain/*` | Доменные модели отдельно от транспорта; маппинг на границе. |
| Go repo реализация (Postgres) | `services/*/*/internal/repository/postgres/*` | SQL только в `.sql` + `//go:embed`. |
| HTTP контракт (OpenAPI) | `services/*/*/api/server/api.yaml` | Для `external|staff`; валидация в Go через `github.com/getkin/kin-openapi`. |
| WS/async контракт (AsyncAPI) | `services/*/*/api/server/asyncapi.yaml` | Для WebSocket/async сообщений, если используется. |
| Общие библиотеки | `libs/{go,vue,ts,js}/*` | Только реально переиспользуемое; без доменной логики конкретного продукта. |

## Границы сервисов и разделение ответственности

Правила:
- Один сервис = один bounded context и одна “причина для изменения”.
- Запрещено: “service-олигарх”, который знает обо всём.
- Данные: сервис владеет своими данными; доступ другим — через API/события, не через прямой SQL.

Как выделять сервис:
- По бизнес-терминам/процессам (не по таблицам/технологиям).
- Если части меняются независимо/масштабируются отдельно — разделяйте.

Запрещено:
- Доменная логика в edge-сервисах (external/staff должны быть thin-edge).
- Дублировать “общие утилиты” в каждом сервисе вместо `libs/`.
- Общие таблицы/схемы БД без явного владельца.
