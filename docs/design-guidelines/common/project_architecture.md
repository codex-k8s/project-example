# Архитектура проекта

Цель: предсказуемое развитие системы.
- Бизнес-логика изолирована от инфраструктуры/транспортов.
- Сервисы слабо связаны; изменения локализуются в домене.
- Транспортные контракты (gRPC/HTTP/events) типизированы и версионируемы; доменные модели живут отдельно от транспорта и маппятся на границе.
- Эксплуатация (деплой/наблюдаемость/конфиг) стандартизирована.

База: DDD (bounded contexts) + Clean Architecture (зависимости “снаружи внутрь”) + единый инвентарь деплоя (`services.yaml`) + единый каркас директорий.

## Микросервисы и монорепозиторий

Правила:
- Сервис = единица деплоя/масштабирования; нельзя “склеивать” разные домены ради удобства.
- Взаимодействие: gRPC (внутри) / RabbitMQ (async) / HTTP(внешнее, обычно через gateway/BFF) / WebSocket (real-time по необходимости).
- Shared DB между сервисами — исключение (предпочитайте API/события).
- gRPC-контракты — из `proto/` (single source of truth) + генерация; домен не равен proto и не “копируется” из него.

## Структура репозитория

Верхний уровень (смысл):
- `services.yaml` — инвентарь того, что деплоится/как настраивается по окружениям. Деплоится с использованием `github.com/codex-k8s/codexctl`.
- `services/` — все сервисы по зонам (`internal|external|staff|jobs|dev`).
- `libs/` — переиспользуемый код (по языкам/назначению).
- `proto/` — единый источник правды **gRPC** контрактов + генерация + проверки совместимости.
- `deploy/` — общая инфраструктура/манифесты.
- `docs/` — документация.
- `scripts/` — утилиты/генерация/CI helpers.
- `.github/` — CI/CD.

Соглашения:
- Имена сервисов/директорий — `kebab-case`.
- Один сервис = `services/<zone>/<service-name>/`.
- Снаружи все сервисы выглядят одинаково (единый каркас).

Контракты транспорта (YAML/Proto):
- gRPC: `proto/` (protobuf).
- HTTP: OpenAPI YAML (`api/server/api.yaml` в сервисе).
- Async: AsyncAPI YAML (`api/server/asyncapi.yaml` в сервисе) — для WebSocket и RabbitMQ.

## Зоны сервисов: internal / external / staff / jobs / dev

Зона определяет доступ и набор обязательных требований.

### `services/internal/`
Правила:
- Только внутренние сервисы; без публичного ingress.
- Основной транспорт: gRPC + очередь; HTTP — только тех. эндпоинты (health/metrics).
- Доступ ограничивать сетевыми политиками/mesh.

### `services/external/`
Правила:
- Публичные API (gateway/BFF/edge).
- Обязательно: authn/authz + rate limiting + аудит.
- Типичные транспорты: HTTP/REST, WebSocket; внутрь — gRPC/HTTP.
- Запрещено: прямое подключение к RabbitMQ (AMQP). Async (RabbitMQ) живёт в `internal|jobs`.
- HTTP API описывается OpenAPI (спека хранится рядом с сервисом).
- UI/клиентские приложения для внешних пользователей (frontend) живут здесь.

### `services/staff/`
Правила:
- Сервисы для сотрудников (VPN/SSO/IP allowlist и т.п.).
- Обязательно: аудит действий; отдельные роли/права; отдельные маршруты/домены.
- Запрещено: прямое подключение к RabbitMQ (AMQP). Async (RabbitMQ) живёт в `internal|jobs`.
- UI/приложения для сотрудников живут здесь.

### `services/jobs/`
Правила:
- Фоновые задачи (CronJob/worker/consumer).
- Обязательно: идемпотентность + корректные ретраи; health/metrics есть, но не публично.
- Здесь допустимы consumer/publisher RabbitMQ (если нужно).

### `services/dev/`
Правила:
- Только для разработки; не деплоятся в staging/prod; должны быть явно выключены через `services.yaml`.
- Здесь могут быть dev-only сервисы и dev-only frontend (панели тестирования/отладки).

Требования к структуре сервисов по языкам:
- Детали структуры Go-сервиса см. `docs/design-guidelines/go/services_design_requirements.md`.
- Детали структуры Vue-приложения см. `docs/design-guidelines/vue/frontend_architecture.md`.

## Границы сервисов и разделение ответственности

Правила:
- Один сервис = один bounded context и одна “причина для изменения”.
- Запрещено: “service-олигарх”, который знает обо всём.
- Данные: сервис владеет своими данными; доступ другим — через API/события, не через прямой SQL.

Как выделять сервис:
- По бизнес-терминам/процессам (не по таблицам/технологиям).
- Если части меняются независимо/масштабируются отдельно — разделяйте.

Запрещено:
- Доменная логика в edge-сервисах (external/staff должны быть thin-edge).
- Дублировать “общие утилиты” в каждом сервисе вместо `libs/`.
- Общие таблицы/схемы БД без явного владельца.
