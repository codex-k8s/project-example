# 8 — Допустимые исключения из правил

## Зачем
Стандарт должен быть практичным: иногда компромисс оправдан, но должен быть ограничен и осознан.

## Общее условие для исключения
Исключение допустимо, если оно:
- реально упрощает код,
- не ломает границы,
- не создаёт новый публичный контракт,
- не даёт дублирующее логирование,
- не ухудшает безопасность.

---

## Исключение 1: локальная HTTP ошибка в handler
Допустимо:
- простая проверка только для одного endpoint,
- не доменное правило,
- не требуется повторное использование.

---

## Исключение 2: локальная обработка ради fallback-ответа
Допустимо:
- фоллбэк — часть ожидаемого поведения,
- клиент должен получить 200/OK,
- деградация согласована и документирована.

---

## Исключение 3: логирование 4xx в debug/trace режимах
Допустимо временно:
- под фича-флагом/конфигом,
- без чувствительных данных,
- не уровнем Error,
- с обязательным удалением после расследования.

---

## Исключение 4: подробности ошибок валидации только вне prod
Допустимо в dev/stage:
- добавлять “details” для ускорения разработки,
- в prod детали реализации запрещены.

---

## Исключение 5: gRPC handler возвращает status.Error напрямую
Допустимо редко, если:
- ошибка специфична gRPC и не доменная,
- не нужна в HTTP,
- не стоит вводить новый typed error.

---

## Исключение 6: health/readiness/metrics
Допустимо:
- минимальный формат, без общего контракта ошибок,
- главное — корректный статус доступности.

---

## Исключение 7: нормализация нестабильных внешних ошибок в service
Допустимо:
- внешний провайдер “плавает” по контракту,
- нужно привести к стабильной доменной семантике.

---

## Исключение 8: временное логирование ниже границы при инциденте
Допустимо:
- только под флагом,
- только на время инцидента,
- обязательно убрать и зафиксировать в тикете.

---

## Исключение 9: fire-and-forget goroutines
Допустимо, если:
- результат не важен,
- panic обработан,
- риск приемлем.

---

## Исключение 10: panic при нарушении инварианта
Допустимо:
- для “невозможных” ситуаций (ошибка программиста),
- panic ловится recovery на границе и превращается в internal.

---

## Исключение 11: логировать ошибки деградации ниже границы
Суть:
- если ошибка не влияет на статус результата (есть фоллбэк),
- логируем в месте принятия решения о деградации,
- не пробрасываем ошибку и не логируем её повторно на границе.

Требования:
- в логе явно указать “fallback/degraded” + причина + компонент.
