# 4 — HTTP API + OpenAPI: единая обработка ошибок

## Зачем
Сделать HTTP API предсказуемым: валидация входа одна, формат ошибок один, логирование централизовано.

## Поток обработки (концептуально)
`Request -> middleware -> OpenAPI validation -> handler -> service/repo -> error -> central HTTP error handler -> Response`

Ключевая идея:
- handler не занимается “валидацией схемы” и не форматирует ошибки;
- вся логика ошибки собирается в одном error handler.

## Валидация OpenAPI
Назначение:
- проверка типов/обязательных параметров;
- проверка body по schema;
- единое поведение для всех endpoints.

Правило:
- OpenAPI-валидация выполняется **только** в middleware.
  Handler’ам запрещено:
- повторно валидировать типы/обязательность;
- разбирать raw body вручную “для проверки”.

## Ошибки OpenAPI-валидации
Статус:
- по умолчанию 400 (возможен 422, но выбор должен быть единым для проекта).

Ответ клиенту должен быть стабильным и безопасным, например:
- `message`: фиксированное общее сообщение,
- `loc`: где ошибка (query/path/header/body),
- `field`: имя поля (если применимо).

Детали реализации (внутренний текст ошибки) в prod не выдаём.

## Central HTTP error handler (граница для HTTP)
Это единственная точка, где:
- выбирается HTTP статус,
- формируется тело ответа,
- логируются неожиданные ошибки.

### Рекомендуемый порядок обработки
1) `context.Canceled`
2) “готовая” HTTP-ошибка (если фреймворк использует собственный тип)
3) OpenAPI validation error
4) доменные typed errors
5) остальное -> 500

## Маппинг доменных ошибок в HTTP (база)
- Validation -> 400
- Unauthorized -> 401
- Forbidden -> 403
- NotFound -> 404
- Conflict -> 409
- Остальное -> 500

## Логирование в HTTP
Логируем (обычно как error):
- 5xx: БД/внешние сервисы/паники/сериализация/инварианты.

Не логируем как ошибку:
- OpenAPI validation,
- бизнес-валидация,
- not found,
- `context.Canceled`.

Разрешено (как исключение): логировать 4xx на debug/info при расследованиях.

## Локальные HTTP ошибки
Допускается создать HTTP-ошибку в handler **только** для простых локальных проверок (не доменных и не переиспользуемых).
Запрещено: использовать это в service/repository как стандартный механизм.

## Отмена и дедлайны
- `context.Canceled`: не считаем ошибкой, обычно не логируем.
- `context.DeadlineExceeded`: логируем как warn; отдаём 504, если это принято в API.

## Параллельность в HTTP handler
Если внутри запроса есть параллельные задачи:
- используйте `errgroup.WithContext`,
- ошибки агрегируйте до возврата,
- логирование — уже в центральном error handler.
