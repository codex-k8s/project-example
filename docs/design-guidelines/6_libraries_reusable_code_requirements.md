# Библиотеки: требования к выносу переиспользуемого кода

Когда выносить в `libs/`:
- код нужен минимум в 2 сервисах и повторение уже появилось/неизбежно,
- требуется единый стандарт поведения (логирование, метрики, трейсинг, клиенты),
- контракт и поведение должны быть одинаковыми во всей системе.

Когда НЕ выносить:
- если это специфично для одного сервиса/домена,
- если API ещё слишком “сырой” и будет постоянно ломаться,
- если библиотека станет “бог-утилитой” без чёткой ответственности.

Правила:
- библиотека должна иметь:
    - чёткое назначение,
    - минимальный публичный API,
    - README с контрактами и примерами,
    - семантику ошибок и совместимость версий.

## Библиотеки: проектирование и зависимости

Правила:
- библиотеки не должны “утаскивать” внутрь бизнес-логики конкретный фреймворк без необходимости.
- публичные API — минимальны и стабильны.
- зависимости — осознанные:
    - избегать тяжёлых зависимостей ради мелкой функции,
    - не тащить лишние инфраструктурные SDK в доменные библиотеки.

Рекомендации:
- выделяйте библиотеки по категориям:
    - `libs/go/observability/*` (логгер/метрики/otel),
    - `libs/go/transport/*` (http/grpc middlewares),
    - `libs/go/storage/*` (postgres helpers, миграции),
    - `libs/go/mq/*` (rabbitmq publisher/consumer utils),
    - `libs/go/cache/*` (redis cache helpers).

## Библиотеки: совместимость и изменение API

Правила:
- изменения библиотек должны быть обратно совместимыми по умолчанию.
- если нужен breaking change:
    - план миграции,
    - одновременная поддержка старого и нового API (по возможности),
    - фиксация в changelog/ADR.

Практика:
- для proto-контрактов:
    - не переименовывать/не переиспользовать номера полей,
    - добавлять поля только с новыми номерами,
    - удаление полей — только через “deprecate → migrate → remove” цикл.

## Protobuf/gRPC: правила контрактов

Правила:
- `.proto` — единственный источник правды для внутренних API.
- Версионирование:
    - пространство имён (package) содержит версию: `myproduct.v1`,
    - breaking changes приводят к `v2` (или формальному плану миграции).
- Совместимость:
    - не менять номера полей,
    - не менять семантику существующих полей,
    - добавлять новые поля как опциональные (по смыслу).

Ошибки:
- gRPC методы возвращают коды статусов корректно:
    - not found → `NotFound`,
    - validation → `InvalidArgument`,
    - conflict → `AlreadyExists`/`FailedPrecondition`,
    - временная недоступность → `Unavailable`.

Документация:
- все публичные сообщения/поля имеют комментарии (назначение, единицы измерения, ограничения).
