# Библиотеки: требования к выносу переиспользуемого кода

Когда выносить в `libs/`:
- нужно минимум в 2 сервисах (повторение уже есть/неизбежно);
- нужен единый стандарт поведения (логирование/метрики/otel/клиенты);
- контракт и поведение должны быть одинаковыми по системе.

Когда НЕ выносить:
- специфично для одного сервиса/домена;
- API “сырой” и будет постоянно ломаться;
- получается “бог-утилита” без чёткой ответственности.

Правила:
- библиотека должна иметь:
    - чёткое назначение,
    - минимальный публичный API,
    - README (контракты + минимальные примеры),
    - правила ошибок и совместимость версий.

## Библиотеки: проектирование и зависимости

Правила:
- Не “утаскивать” фреймворки внутрь бизнес-логики без необходимости.
- Публичный API минимален и стабилен.
- Зависимости осознанные: не тащить тяжёлое ради мелочи; не затягивать инфраструктурные SDK в доменные библиотеки.

Рекомендации:
- выделяйте библиотеки по категориям:
    - `libs/go/observability/*` (логгер/метрики/otel),
    - `libs/go/transport/*` (http/grpc middlewares),
    - `libs/go/storage/*` (postgres helpers, миграции),
    - `libs/go/mq/*` (rabbitmq publisher/consumer utils),
    - `libs/go/cache/*` (redis cache helpers).

## Библиотеки: совместимость и изменение API

Правила:
- По умолчанию изменения обратно совместимы.
- Breaking change допускается только с планом миграции; по возможности — временная поддержка old+new; зафиксировать в changelog/ADR, создать Issue на миграцию.

Практика:
- Для `proto`: не переиспользовать номера; добавлять поля только с новыми номерами; удаление — через `deprecate -> migrate -> remove`.

## Protobuf/gRPC: правила контрактов

Правила:
- `.proto` — единственный источник правды для **gRPC транспорта** внутренних API (а не для доменных моделей).
- Доменные модели живут в `internal/domain/types/*` и маппятся на транспорт через `internal/domain/casters/*` (не “генерируются из proto” и не копипастятся).
- Версионирование:
    - package содержит версию (`myproduct.v1`),
    - breaking changes -> `v2` (или формальный план миграции).
- Совместимость:
    - не менять номера полей,
    - не менять семантику существующих полей,
    - добавлять новые поля как опциональные (по смыслу).

Ошибки:
- gRPC методы должны возвращать корректные status codes (not found -> `NotFound`; validation -> `InvalidArgument`; conflict -> `AlreadyExists`/`FailedPrecondition`; temporary unavailable -> `Unavailable`).

Документация:
- все публичные сообщения/поля имеют комментарии (назначение, единицы измерения, ограничения).
