name: "Staging deploy  ðŸš€"

on:
  push:
    branches: [main]

concurrency:
  group: staging-deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: "Deploy staging via codexctl ðŸš€"
    if: >
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[skip-ci]') &&
      !contains(github.event.head_commit.message, '[no ci]') &&
      !contains(github.event.head_commit.message, '[no-ci]')
    runs-on: self-hosted
    environment: staging
    env:
      PATH: /usr/local/go/bin:/usr/local/bin:/usr/bin:/bin
    steps:
      - name: "Checkout project-example ðŸ“¥"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Checkout codexctl ðŸ“¥"
        uses: actions/checkout@v4
        with:
          repository: codex-k8s/codexctl
          ref: main
          path: ./.codexctl
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Build codexctl âš’ï¸"
        env:
          PATH: /usr/local/go/bin:/usr/local/bin:/usr/bin:/bin
        run: |
          set -euo pipefail
          cd ./.codexctl
          go build -o ../codexctl ./cmd/codexctl

      - name: "Mirror external images ðŸªž"
        env:
          REGISTRY_HOST: localhost:32000
          PATH: /usr/local/go/bin:/usr/local/bin:/usr/bin:/bin
        run: |
          set -euo pipefail
          ./codexctl images mirror --env staging

      - name: "Build service images ðŸ—ï¸"
        env:
          REGISTRY_HOST: localhost:32000
          PATH: /usr/local/go/bin:/usr/local/bin:/usr/bin:/bin
        run: |
          set -euo pipefail
          ./codexctl images build --env staging

      - name: "Apply staging via codexctl ðŸš€"
        env:
          GITHUB_RUN_ID:        ${{ github.run_id }}
          CODEX_GH_PAT:         ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME:    ${{ secrets.CODEX_GH_USERNAME }}
          OPENAI_API_KEY:       ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:     ${{ secrets.CONTEXT7_API_KEY }}
          CODE_ROOT_BASE:       ${{ vars.CODE_ROOT_BASE }}
          DATA_ROOT:            ${{ vars.DATA_ROOT }}
          POSTGRES_USER:        ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD:    ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD:       ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY:           ${{ secrets.SECRET_KEY }}
          PATH:                 /usr/local/go/bin:/usr/local/bin:/usr/bin:/bin
        run: |
          set -euo pipefail
          ./codexctl apply --env staging --wait --preflight

  gc-registry:
    needs: deploy
    runs-on: self-hosted
    environment: staging
    steps:
      - name: "Checkout ðŸ“¥"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "GC docker registry container ðŸ—‘ï¸"
        run: |
          set -euo pipefail
          NAME="${DOCKER_REGISTRY_CONTAINER:-project-example-registry}"
          if ! docker ps --format '{{.Names}}' | grep -q "^${NAME}$"; then
            echo "info: registry container ${NAME} not running" >&2
            exit 0
          fi
          echo "info: running registry GC inside ${NAME} (--delete-untagged=true)" >&2
          set +e
          docker exec "${NAME}" registry garbage-collect /etc/docker/registry/config.yml --delete-untagged=true
          RC=$?
          set -e
          if [[ $RC -ne 0 ]]; then
            echo "warn: GC with --delete-untagged failed; retrying without flag" >&2
            docker exec "${NAME}" registry garbage-collect /etc/docker/registry/config.yml || true
          fi
          echo "info: GC finished" >&2
        shell: bash
