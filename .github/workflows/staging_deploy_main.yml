name: "Staging deploy  ðŸš€"

on:
  push:
    branches: [main]

concurrency:
  group: staging-deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: "Deploy staging via codexctl ðŸš€"
    if: >
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[skip-ci]') &&
      !contains(github.event.head_commit.message, '[no ci]') &&
      !contains(github.event.head_commit.message, '[no-ci]')
    runs-on: self-hosted
    environment: staging
    steps:
      - name: "Checkout project-example ðŸ“¥"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Install codexctl ðŸ› ï¸"
        env:
          CODEXCTL_VERSION: ${{ vars.CODEXCTL_VERSION }}
        run: |
          set -euo pipefail
          VERSION="${CODEXCTL_VERSION:-latest}"
          export GOBIN="${HOME}/.local/bin"
          mkdir -p "$GOBIN"
          GOPATH_BIN="$(go env GOPATH)/bin"
          echo "$GOBIN" >> "$GITHUB_PATH"
          echo "$GOPATH_BIN" >> "$GITHUB_PATH"
          echo "PATH=$GOBIN:$GOPATH_BIN:$PATH" >> "$GITHUB_ENV"
          export PATH="$GOBIN:$GOPATH_BIN:$PATH"
          export GOPRIVATE=github.com/codex-k8s/*
          export GONOSUMDB=github.com/codex-k8s/*
          export GOPROXY=direct
          go install github.com/codex-k8s/codexctl/cmd/codexctl@${VERSION}
          INSTALLED_VER="$(go list -m -f '{{.Version}}' github.com/codex-k8s/codexctl@${VERSION})"
          echo "codexctl module version: ${INSTALLED_VER}"
          codexctl --help >/dev/null
      - name: "Prepare images via codexctl ðŸªžðŸ—ï¸"
        env:
          REGISTRY_HOST: localhost:32000
        run: |
          set -euo pipefail
          codexctl ci images --env staging --mirror --build

      - name: "Apply staging via codexctl ðŸš€"
        env:
          KUBECONFIG:           /home/runner/.kube/microk8s.config
          NO_PROXY:             127.0.0.1,localhost,::1
          GITHUB_RUN_ID:        ${{ github.run_id }}
          CODEX_GH_PAT:         ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME:    ${{ vars.CODEX_GH_USERNAME }}
          OPENAI_API_KEY:       ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:     ${{ secrets.CONTEXT7_API_KEY }}
          CODE_ROOT_BASE:       ${{ vars.CODE_ROOT_BASE }}
          DATA_ROOT:            ${{ vars.DATA_ROOT }}
          POSTGRES_USER:        ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD:    ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD:       ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY:           ${{ secrets.SECRET_KEY }}
        run: |
          set -euo pipefail
          codexctl ci apply --env staging --preflight --wait

  gc-registry:
    needs: deploy
    runs-on: self-hosted
    environment: staging
    steps:
      - name: "Checkout ðŸ“¥"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "GC docker registry container ðŸ—‘ï¸"
        run: |
          set -euo pipefail
          NAME="${DOCKER_REGISTRY_CONTAINER:-project-example-registry}"
          if ! docker ps --format '{{.Names}}' | grep -q "^${NAME}$"; then
            echo "info: registry container ${NAME} not running" >&2
            exit 0
          fi
          echo "info: running registry GC inside ${NAME} (--delete-untagged=true)" >&2
          set +e
          docker exec "${NAME}" registry garbage-collect /etc/docker/registry/config.yml --delete-untagged=true
          RC=$?
          set -e
          if [[ $RC -ne 0 ]]; then
            echo "warn: GC with --delete-untagged failed; retrying without flag" >&2
            docker exec "${NAME}" registry garbage-collect /etc/docker/registry/config.yml || true
          fi
          echo "info: GC finished" >&2
        shell: bash
