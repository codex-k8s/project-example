name: "Staging deploy  ðŸš€"

on:
  push:
    branches: [main]

env:
  CODEXCTL_GH_USERNAME:    ${{ vars.CODEXCTL_GH_USERNAME }}
  CODEXCTL_GH_EMAIL:       ${{ vars.CODEXCTL_GH_EMAIL }}
  CODEXCTL_CODE_ROOT_BASE: ${{ vars.CODEXCTL_CODE_ROOT_BASE }}
  CODEXCTL_DATA_ROOT:      ${{ vars.CODEXCTL_DATA_ROOT }}
  CODEXCTL_ENV:            staging
  CODEXCTL_WORKSPACE_UID:  ${{ vars.CODEXCTL_WORKSPACE_UID }}
  CODEXCTL_WORKSPACE_GID:  ${{ vars.CODEXCTL_WORKSPACE_GID }}
  CODEXCTL_REPO:           ${{ github.repository }}

concurrency:
  group: staging-deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: "Deploy staging via codexctl ðŸš€"
    if: >
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[skip-ci]') &&
      !contains(github.event.head_commit.message, '[no ci]') &&
      !contains(github.event.head_commit.message, '[no-ci]')
    runs-on: self-hosted
    environment: staging
    steps:
      - name: "Checkout project-example ðŸ“¥"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          token: ${{ secrets.CODEXCTL_GH_PAT }}

      - name: "Sync staging sources ðŸ“‚"
        run: |
          set -euo pipefail
          codexctl ci sync-sources

      - name: "Prepare images via codexctl ðŸªžðŸ—ï¸"
        env:
          CODEXCTL_MIRROR_IMAGES: true
          CODEXCTL_BUILD_IMAGES:  true
          REGISTRY_HOST: localhost:32000
        run: |
          set -euo pipefail
          codexctl ci images

      - name: "Apply staging via codexctl ðŸš€"
        env:
          KUBECONFIG:           /home/runner/.kube/microk8s.config
          NO_PROXY:             127.0.0.1,localhost,::1
          GITHUB_RUN_ID:        ${{ github.run_id }}
          CODEXCTL_GH_PAT:         ${{ secrets.CODEXCTL_GH_PAT }}
          CODEXCTL_PREFLIGHT:      true
          CODEXCTL_WAIT:           true
          OPENAI_API_KEY:       ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:     ${{ secrets.CONTEXT7_API_KEY }}
          POSTGRES_USER:        ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD:    ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD:       ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY:           ${{ secrets.SECRET_KEY }}
        run: |
          set -euo pipefail
          codexctl ci apply

  gc-registry:
    needs: deploy
    runs-on: self-hosted
    environment: staging
    steps:
      - name: "Checkout ðŸ“¥"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEXCTL_GH_PAT }}

      - name: "GC docker registry container ðŸ—‘ï¸"
        run: |
          set -euo pipefail
          NAME="${DOCKER_REGISTRY_CONTAINER:-project-example-registry}"
          if ! docker ps --format '{{.Names}}' | grep -q "^${NAME}$"; then
            echo "info: registry container ${NAME} not running" >&2
            exit 0
          fi
          echo "info: running registry GC inside ${NAME} (--delete-untagged=true)" >&2
          set +e
          docker exec "${NAME}" registry garbage-collect /etc/docker/registry/config.yml --delete-untagged=true
          RC=$?
          set -e
          if [[ $RC -ne 0 ]]; then
            echo "warn: GC with --delete-untagged failed; retrying without flag" >&2
            docker exec "${NAME}" registry garbage-collect /etc/docker/registry/config.yml || true
          fi
          echo "info: GC finished" >&2
        shell: bash
