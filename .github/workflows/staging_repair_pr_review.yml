name: "Staging Repair PR Review ðŸ‘"

on:
  pull_request_review:
    types: [submitted]

env:
  AI_ALLOWED_USERS: ${{ vars.AI_ALLOWED_USERS }}
  CODEX_GH_USERNAME: ${{ vars.CODEX_GH_USERNAME }}

concurrency:
  group: staging-repair-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  run:
    name: "Staging repair review run ðŸ¤–"
    if: >-
      github.event.review.state == 'changes_requested' &&
      startsWith(github.event.pull_request.head.ref, 'codex/staging-repair-') &&
      contains(format(',{0},', vars.AI_ALLOWED_USERS), format(',{0},', github.actor))
    runs-on: self-hosted
    environment: staging
    env:
      CODE_ROOT_BASE:       ${{ vars.CODE_ROOT_BASE }}
      CODEX_GH_PAT:         ${{ secrets.CODEX_GH_PAT }}
      DATA_ROOT:            ${{ vars.DATA_ROOT }}
      GITHUB_RUN_ID:        ${{ github.run_id }}
      CODEX_GH_USERNAME:    ${{ vars.CODEX_GH_USERNAME }}
      KUBECONFIG:           /home/runner/.kube/microk8s.config
      OPENAI_API_KEY:       ${{ secrets.OPENAI_API_KEY }}
      CONTEXT7_API_KEY:     ${{ secrets.CONTEXT7_API_KEY }}
      POSTGRES_USER:        ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD:    ${{ secrets.POSTGRES_PASSWORD }}
      REDIS_PASSWORD:       ${{ secrets.REDIS_PASSWORD }}
      SECRET_KEY:           ${{ secrets.SECRET_KEY }}
    steps:
      - name: "Checkout PR head ðŸ“¥"
        uses: actions/checkout@v4
        with:
          ref:   ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.CODEX_GH_PAT }}
          fetch-depth: 0

      - name: "Sync staging sources ðŸ“‚"
        env:
          CODE_ROOT_BASE: ${{ vars.CODE_ROOT_BASE }}
        run: |
          set -euo pipefail
          if [ -z "${CODE_ROOT_BASE:-}" ]; then
            echo "error: CODE_ROOT_BASE is not set" >&2
            exit 1
          fi
          STAGING_SRC="${CODE_ROOT_BASE}/staging/src"
          mkdir -p "${STAGING_SRC}"
          rsync -a --delete --exclude '.cache' ./ "${STAGING_SRC}/"

      - name: "Resolve slot and namespace for PR ðŸ“‡"
        id: card
        env:
          PR: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          PR_NUMBER="${PR}"
          ARGS=(ci ensure-slot --env staging_repair --pr "${PR_NUMBER}" --output kv)
          OUT="$(codexctl "${ARGS[@]}")"
          echo "$OUT"

          SLOT=""
          NS=""
          while IFS='=' read -r key value; do
            case "$key" in
              slot) SLOT="$value" ;;
              namespace) NS="$value" ;;
            esac
          done < <(printf '%s\n' "$OUT" | sed -n 's/^\([a-zA-Z0-9_]\+\)=\(.*\)$/\1=\2/p')

          if [ -z "${SLOT:-}" ] || [ -z "${NS:-}" ]; then
            echo "error: cannot resolve slot/ns for PR ${PR_NUMBER}" >&2
            exit 1
          fi

          NEW_ENV="false"
          if ! kubectl get ns "${NS}" >/dev/null 2>&1; then
            NEW_ENV="true"
          elif ! kubectl -n "${NS}" get deploy codex >/dev/null 2>&1; then
            NEW_ENV="true"
          fi

          echo "SLOT=$SLOT" >> "$GITHUB_OUTPUT"
          echo "NS=$NS"     >> "$GITHUB_OUTPUT"
          echo "NEW_ENV=$NEW_ENV" >> "$GITHUB_OUTPUT"

      - name: "Ensure staging repair env via codexctl ðŸš€"
        env:
          GITHUB_RUN_ID:        ${{ github.run_id }}
          CODEX_GH_PAT:         ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME:    ${{ vars.CODEX_GH_USERNAME }}
          OPENAI_API_KEY:       ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:     ${{ secrets.CONTEXT7_API_KEY }}
          CODE_ROOT_BASE:       ${{ vars.CODE_ROOT_BASE }}
          DATA_ROOT:            ${{ vars.DATA_ROOT }}
          POSTGRES_USER:        ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD:    ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD:       ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY:           ${{ secrets.SECRET_KEY }}
        run: |
          set -euo pipefail
          SLOT="${{ steps.card.outputs.SLOT }}"
          export CODEX_WORKSPACE_UID="$(id -u)"
          export CODEX_WORKSPACE_GID="$(id -g)"
          codexctl ci apply \
            --env staging_repair \
            --slot "${SLOT}" \
            --preflight \
            --wait \
            --only-infra namespace-and-config,codex-staging-repair-rbac \
            --only-services codex

      - name: "Run Codex staging repair review ðŸ¤–"
        env:
          GITHUB_RUN_ID:     ${{ github.run_id }}
          CODEX_GH_PAT:      ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME: ${{ vars.CODEX_GH_USERNAME }}
          OPENAI_API_KEY:    ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:  ${{ secrets.CONTEXT7_API_KEY }}
        run: |
          set -euo pipefail
          SLOT="${{ steps.card.outputs.SLOT }}"
          NS="${{ steps.card.outputs.NS }}"
          NEW_ENV="${{ steps.card.outputs.NEW_ENV }}"
          PR="${{ github.event.pull_request.number }}"
          KIND="staging_repair_review"
          RESUME_FLAG="--resume"
          VARS=""
          if [ "${NEW_ENV}" = "true" ]; then
            RESUME_FLAG=""
            VARS="PROMPT_CONTINUATION=1,PROMPT_MODE=full"
          fi
          ARGS=(prompt run --env staging_repair --slot "${SLOT}" --kind "${KIND}" --lang ru)
          if [ -n "$NS" ]; then
            ARGS+=(--namespace "$NS")
          fi
          if [ -n "$PR" ]; then
            ARGS+=(--pr "$PR")
          fi
          if [ -n "$VARS" ]; then
            ARGS+=(--vars "$VARS")
          fi
          if [ -n "$RESUME_FLAG" ]; then
            ARGS+=("$RESUME_FLAG")
          fi
          codexctl "${ARGS[@]}"

      - name: "Apply review changes and comment ðŸ’¾"
        env:
          SLOT:               ${{ steps.card.outputs.SLOT }}
          PR_NUMBER:          ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY:  ${{ github.repository }}
          CODEX_GH_PAT:       ${{ secrets.CODEX_GH_PAT }}
        run: |
          set -euo pipefail
          codexctl pr review-apply \
            --env staging_repair \
            --slot "${SLOT}" \
            --pr "${PR_NUMBER}" \
            --code-root-base "${CODE_ROOT_BASE}" \
            --lang ru

      - name: "Cleanup staging repair env on failure ðŸ§¹"
        if: (failure() || cancelled()) && steps.card.outputs.SLOT != ''
        env:
          SLOT: ${{ steps.card.outputs.SLOT }}
        run: |
          set -euo pipefail
          codexctl manage-env cleanup --env staging_repair --slot "${SLOT}" --with-configmap || true
