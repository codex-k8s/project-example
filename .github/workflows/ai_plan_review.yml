name: "AI Plan Review ðŸ‘"

on:
  issue_comment:
    types: [created]

env:
  AI_ALLOWED_USERS: ${{ vars.AI_ALLOWED_USERS }}
  CODEX_GH_USERNAME: ${{ vars.CODEX_GH_USERNAME }}

concurrency:
  group: ai-plan-review-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  run:
    name: "Planning review agent run ðŸ¤–"
    if: >
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '[ai-plan]') &&
      contains(format(',{0},', vars.AI_ALLOWED_USERS), format(',{0},', github.actor))
    runs-on: self-hosted
    environment: staging
    env:
      CODE_ROOT_BASE:       ${{ vars.CODE_ROOT_BASE }}
      CODEX_GH_PAT:         ${{ secrets.CODEX_GH_PAT }}
      DATA_ROOT:            ${{ vars.DATA_ROOT }}
      GITHUB_RUN_ID:        ${{ github.run_id }}
      CODEX_GH_USERNAME:    ${{ vars.CODEX_GH_USERNAME }}
      OPENAI_API_KEY:       ${{ secrets.OPENAI_API_KEY }}
      CONTEXT7_API_KEY:     ${{ secrets.CONTEXT7_API_KEY }}
      POSTGRES_USER:        ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD:    ${{ secrets.POSTGRES_PASSWORD }}
      REDIS_PASSWORD:       ${{ secrets.REDIS_PASSWORD }}
      SECRET_KEY:           ${{ secrets.SECRET_KEY }}
    steps:
      - name: "Checkout project-example ðŸ“¥"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_GH_PAT }}
          persist-credentials: true
          fetch-depth: 1

      - name: "Resolve root planning issue ðŸ”—"
        id: root_issue
        env:
          FOCUS_ISSUE_NUMBER: ${{ github.event.issue.number }}
          GITHUB_REPOSITORY:  ${{ github.repository }}
          CODEX_GH_PAT:       ${{ secrets.CODEX_GH_PAT }}
        run: |
          set -euo pipefail
          FOCUS="${FOCUS_ISSUE_NUMBER}"
          REPO="${GITHUB_REPOSITORY}"

          OUT="$(codexctl plan resolve-root --issue "${FOCUS}" --repo "${REPO}" --output kv)"
          echo "$OUT"

          ROOT=""
          FOCUS_RESOLVED=""
          while IFS='=' read -r key value; do
            case "$key" in
              root) ROOT="$value" ;;
              focus) FOCUS_RESOLVED="$value" ;;
            esac
          done < <(printf '%s\n' "$OUT" | sed -n 's/^\([a-zA-Z0-9_]\+\)=\(.*\)$/\1=\2/p')

          if [ -z "${ROOT}" ] || [ "${ROOT}" = "0" ]; then
            echo "error: unable to determine root planning issue for focus issue ${FOCUS}" >&2
            exit 1
          fi

          echo "ROOT_ISSUE_NUMBER=${ROOT}" >> "$GITHUB_OUTPUT"
          echo "FOCUS_ISSUE_NUMBER=${FOCUS_RESOLVED}" >> "$GITHUB_OUTPUT"

      - name: "Resolve slot and namespace for root issue ðŸ“‡"
        id: card
        env:
          ROOT_ISSUE_NUMBER: ${{ steps.root_issue.outputs.ROOT_ISSUE_NUMBER }}
          DEV_SLOTS_MAX:     ${{ vars.DEV_SLOTS_MAX }}
        run: |
          set -euo pipefail

          ROOT="${ROOT_ISSUE_NUMBER}"
          MAX="${DEV_SLOTS_MAX:-}"

          echo "info: ensuring AI planning environment ready via codexctl (ensure-ready)" >&2
          export CODEX_WORKSPACE_UID="$(id -u)"
          export CODEX_WORKSPACE_GID="$(id -g)"
          ARGS=(ci ensure-ready --env ai --issue "${ROOT}" --code-root-base "${CODE_ROOT_BASE}" --source "." --prepare-images --apply --output kv)
          if [ -n "${MAX}" ]; then
            ARGS+=(--max "${MAX}")
          fi
          OUT="$(codexctl "${ARGS[@]}")"
          echo "$OUT"

          SLOT=""
          NS=""
          CREATED="false"
          RECREATED="false"
          while IFS='=' read -r key value; do
            case "$key" in
              slot) SLOT="$value" ;;
              namespace) NS="$value" ;;
              created) CREATED="$value" ;;
              recreated) RECREATED="$value" ;;
            esac
          done < <(printf '%s\n' "$OUT" | sed -n 's/^\([a-zA-Z0-9_]\+\)=\(.*\)$/\1=\2/p')

          NEW_ENV="false"
          if [ "${CREATED}" = "true" ] || [ "${RECREATED}" = "true" ]; then
            NEW_ENV="true"
          fi

          if [ -z "${SLOT:-}" ] || [ -z "${NS:-}" ]; then
            echo "error: cannot resolve slot/ns for root planning issue ${ROOT}" >&2
            exit 1
          fi

          echo "SLOT=$SLOT" >> "$GITHUB_OUTPUT"
          echo "NS=$NS"     >> "$GITHUB_OUTPUT"
          echo "NEW_ENV=$NEW_ENV" >> "$GITHUB_OUTPUT"

      - name: "Run planning review agent via codexctl ðŸ¤–"
        env:
          GITHUB_RUN_ID:         ${{ github.run_id }}
          CODEX_GH_PAT:          ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME:     ${{ vars.CODEX_GH_USERNAME }}
          OPENAI_API_KEY:        ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:      ${{ secrets.CONTEXT7_API_KEY }}
          ROOT_ISSUE_NUMBER:     ${{ steps.root_issue.outputs.ROOT_ISSUE_NUMBER }}
          FOCUS_ISSUE_NUMBER:    ${{ steps.root_issue.outputs.FOCUS_ISSUE_NUMBER }}
        run: |
          set -euo pipefail

          ROOT="${ROOT_ISSUE_NUMBER}"
          FOCUS="${FOCUS_ISSUE_NUMBER}"
          SLOT_VAL="${{ steps.card.outputs.SLOT }}"
          NS_VAL="${{ steps.card.outputs.NS }}"
          NEW_ENV="${{ steps.card.outputs.NEW_ENV }}"

          KIND="plan_review"
          RESUME_FLAG="--resume"
          VARS="FOCUS_ISSUE_NUMBER=${FOCUS}"
          if [ "${NEW_ENV}" = "true" ]; then
            RESUME_FLAG=""
            VARS="FOCUS_ISSUE_NUMBER=${FOCUS},PROMPT_CONTINUATION=1,PROMPT_MODE=full"
          fi

          ARGS=(prompt run --env ai --slot "${SLOT_VAL}" --kind "${KIND}" --lang ru)
          if [ -n "$NS_VAL" ]; then
            ARGS+=(--namespace "$NS_VAL")
          fi
          if [ -n "$ROOT" ]; then
            ARGS+=(--issue "$ROOT")
          fi

          ARGS+=(--vars "$VARS")

          if [ -n "$RESUME_FLAG" ]; then
            ARGS+=("$RESUME_FLAG")
          fi

          codexctl "${ARGS[@]}"
