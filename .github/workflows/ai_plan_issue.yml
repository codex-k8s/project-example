name: "AI Plan ðŸ§­"

on:
  issues:
    types: [labeled]

concurrency:
  group: ai-plan-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  create-ai-plan:
    if: github.event.label.name == '[ai-plan]'
    name: "Allocate plan slot ðŸ§©"
    runs-on: self-hosted
    timeout-minutes: 360
    environment: staging
    outputs:
      slot: ${{ steps.alloc.outputs.slot }}
      namespace: ${{ steps.alloc.outputs.namespace }}
    steps:
      - name: "Checkout project-example ðŸ“¥"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Checkout codexctl ðŸ“¥"
        uses: actions/checkout@v4
        with:
          repository: codex-k8s/codexctl
          ref: main
          path: ./.codexctl
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Build codexctl âš’ï¸"
        env:
          PATH: ${{ env.PATH }}:/usr/local/go/bin:/usr/local/bin
        run: |
          set -euo pipefail
          cd ./.codexctl
          go build -o ../codexctl ./cmd/codexctl

      - name: "Allocate slot via codexctl ðŸ§©"
        id: alloc
        env:
          GITHUB_RUN_ID:     ${{ github.run_id }}
          CODEX_GH_PAT:      ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME: ${{ secrets.CODEX_GH_USERNAME }}
          PATH:              /usr/local/go/bin:/usr/local/bin:${{ env.PATH }}
        run: |
          set -euo pipefail
          ENV_NAME="ai"
          ISSUE="${{ github.event.issue.number }}"
          MAX="${{ vars.DEV_SLOTS_MAX }}"

          ARGS=(manage-env ensure-slot --env "${ENV_NAME}" --issue "${ISSUE}" --output json)
          if [ -n "$MAX" ]; then
            ARGS+=(--max "$MAX")
          fi

          OUT="$(./codexctl "${ARGS[@]}")"
          echo "$OUT"
          SLOT="$(echo "$OUT" | jq -r '.slot')"
          NS="$(echo "$OUT"   | jq -r '.namespace')"
          echo "slot=$SLOT" >> "$GITHUB_OUTPUT"
          echo "namespace=$NS" >> "$GITHUB_OUTPUT"

  deploy-ai-plan:
    needs: [create-ai-plan]
    name: "Deploy AI plan env ðŸš€"
    runs-on: self-hosted
    environment: staging
    steps:
      - name: "Checkout project-example ðŸ“¥"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Checkout codexctl ðŸ“¥"
        uses: actions/checkout@v4
        with:
          repository: codex-k8s/codexctl
          ref: main
          path: ./.codexctl
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Build codexctl âš’ï¸"
        env:
          PATH: ${{ env.PATH }}:/usr/local/go/bin:/usr/local/bin
        run: |
          set -euo pipefail
          cd ./.codexctl
          go build -o ../codexctl ./cmd/codexctl

      - name: "Apply AI plan env via codexctl ðŸš€"
        env:
          GITHUB_RUN_ID:        ${{ github.run_id }}
          CODEX_GH_PAT:         ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME:    ${{ secrets.CODEX_GH_USERNAME }}
          OPENAI_API_KEY:       ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:     ${{ secrets.CONTEXT7_API_KEY }}
          CODE_ROOT_BASE:       ${{ vars.CODE_ROOT_BASE }}
          DATA_ROOT:            ${{ vars.DATA_ROOT }}
          POSTGRES_USER:        ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD:    ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD:       ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY:           ${{ secrets.SECRET_KEY }}
          PATH:                 /usr/local/go/bin:/usr/local/bin:${{ env.PATH }}
        run: |
          set -euo pipefail
          SLOT="${{ needs.create-ai-plan.outputs.slot }}"
          ISSUE="${{ github.event.issue.number }}"
          MAX="${{ vars.DEV_SLOTS_MAX }}"
          export CODEX_WORKSPACE_UID="$(id -u)"
          export CODEX_WORKSPACE_GID="$(id -g)"
          ARGS=(manage-env ensure-ready --env ai --slot "${SLOT}" --issue "${ISSUE}" --code-root-base "${CODE_ROOT_BASE}" --source "." --prepare-images --apply --output json)
          if [ -n "$MAX" ]; then
            ARGS+=(--max "$MAX")
          fi
          OUT="$(./codexctl "${ARGS[@]}")"
          echo "$OUT"

  run-codex-plan:
    needs: [create-ai-plan, deploy-ai-plan]
    name: "Run planning agent ðŸ¤–"
    runs-on: self-hosted
    environment: staging
    env:
      CODE_ROOT_BASE: ${{ vars.CODE_ROOT_BASE }}
      CODEX_GH_PAT:   ${{ secrets.CODEX_GH_PAT }}
      PATH:           /usr/local/go/bin:/usr/local/bin:${{ env.PATH }}
    steps:
      - name: "Checkout default branch ðŸ“¥"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Checkout codexctl ðŸ“¥"
        uses: actions/checkout@v4
        with:
          repository: codex-k8s/codexctl
          ref: main
          path: ./.codexctl
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Build codexctl âš’ï¸"
        env:
          PATH: ${{ env.PATH }}:/usr/local/go/bin:/usr/local/bin
        run: |
          set -euo pipefail
          cd ./.codexctl
          go build -o ../codexctl ./cmd/codexctl

      - name: "Run planning agent inline ðŸ¤–"
        env:
          GITHUB_RUN_ID:     ${{ github.run_id }}
          CODEX_GH_PAT:      ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME: ${{ secrets.CODEX_GH_USERNAME }}
          OPENAI_API_KEY:    ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:  ${{ secrets.CONTEXT7_API_KEY }}
        run: |
          set -euo pipefail
          SLOT="${{ needs.create-ai-plan.outputs.slot }}"
          NS="${{ needs.create-ai-plan.outputs.namespace }}"
          ISSUE="${{ github.event.issue.number }}"
          ARGS=(prompt run --env ai --slot "${SLOT}" --kind plan_issue --lang ru)
          if [ -n "$NS" ]; then
            ARGS+=(--namespace "$NS")
          fi
          if [ -n "$ISSUE" ]; then
            ARGS+=(--issue "$ISSUE")
          fi
          ./codexctl "${ARGS[@]}"

  cleanup-ai-plan:
    needs: [create-ai-plan, deploy-ai-plan, run-codex-plan]
    if: always()
    name: "Cleanup plan env on failure ðŸ§¹"
    runs-on: self-hosted
    environment: staging
    env:
      CODEX_GH_PAT: ${{ secrets.CODEX_GH_PAT }}
      DATA_ROOT: ${{ vars.DATA_ROOT }}
      PATH: /usr/local/go/bin:/usr/local/bin:${{ env.PATH }}
    steps:
      - name: "Checkout minimal ðŸ“¥"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Checkout codexctl ðŸ“¥"
        uses: actions/checkout@v4
        with:
          repository: codex-k8s/codexctl
          ref: main
          path: ./.codexctl
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Build codexctl âš’ï¸"
        env:
          PATH: ${{ env.PATH }}:/usr/local/go/bin:/usr/local/bin
        run: |
          set -euo pipefail
          cd ./.codexctl
          go build -o ../codexctl ./cmd/codexctl

      - name: "Cleanup AI plan slot on failure (global) ðŸ§¹"
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail

          STATUS_CREATE="${{ needs.create-ai-plan.result }}"
          STATUS_DEPLOY="${{ needs.deploy-ai-plan.result }}"
          STATUS_RUN="${{ needs.run-codex-plan.result }}"

          if [ "${STATUS_CREATE}" = "success" ] && [ "${STATUS_DEPLOY}" = "success" ] && [ "${STATUS_RUN}" = "success" ]; then
            echo "info: primary AI Plan workflow completed successfully, no cleanup required" >&2
            exit 0
          fi

          ./codexctl manage-env cleanup --env ai --issue "${ISSUE_NUMBER}" --with-configmap || true
