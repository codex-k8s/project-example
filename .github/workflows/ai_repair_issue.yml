name: "Staging Repair üßØ"

on:
  issues:
    types: [labeled]

env:
  CODEXCTL_ALLOWED_USERS:  ${{ vars.CODEXCTL_ALLOWED_USERS }}
  CODEXCTL_GH_USERNAME:    ${{ vars.CODEXCTL_GH_USERNAME }}
  CODEXCTL_ENV:            ai-repair
  CODEXCTL_LANG:           ${{ vars.CODEXCTL_LANG }}
  CODEXCTL_DEV_SLOTS_MAX:  ${{ vars.CODEXCTL_DEV_SLOTS_MAX }}
  CODEXCTL_CODE_ROOT_BASE: ${{ vars.CODEXCTL_CODE_ROOT_BASE }}
  CODEXCTL_DATA_ROOT:      ${{ vars.CODEXCTL_DATA_ROOT }}
  CODEXCTL_GH_EMAIL:       ${{ vars.CODEXCTL_GH_EMAIL }}
  CODEXCTL_WORKSPACE_UID:  ${{ vars.CODEXCTL_WORKSPACE_UID }}
  CODEXCTL_WORKSPACE_GID:  ${{ vars.CODEXCTL_WORKSPACE_GID }}
  CODEXCTL_REPO:           ${{ github.repository }}

concurrency:
  group: ai-repair-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  create-ai-repair:
    name: "Allocate slot üß©"
    if: >-
      github.event.label.name == '[ai-repair]' &&
      contains(format(',{0},', vars.CODEXCTL_ALLOWED_USERS), format(',{0},', github.actor))
    runs-on: self-hosted
    timeout-minutes: 360
    environment: staging
    outputs:
      slot: ${{ steps.alloc.outputs.slot }}
      namespace: ${{ steps.alloc.outputs.namespace }}
    steps:
      - name: "Checkout project-example üì•"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEXCTL_GH_PAT }}

      - name: "Allocate slot via codexctl üß©"
        id: alloc
        env:
          GITHUB_RUN_ID:           ${{ github.run_id }}
          CODEXCTL_GH_PAT:         ${{ secrets.CODEXCTL_GH_PAT }}
          CODEXCTL_ISSUE_NUMBER:   ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          codexctl ci ensure-slot

  deploy-ai-repair:
    needs: [create-ai-repair]
    name: "Deploy staging repair env üöÄ"
    runs-on: self-hosted
    environment: staging
    steps:
      - name: "Checkout project-example üì•"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          token: ${{ secrets.CODEXCTL_GH_PAT }}

      - name: "Sync staging sources üìÇ"
        run: |
          set -euo pipefail
          codexctl ci sync-sources

      - name: "Ensure staging repair env via codexctl üöÄ"
        env:
          GITHUB_RUN_ID:           ${{ github.run_id }}
          CODEXCTL_GH_PAT:         ${{ secrets.CODEXCTL_GH_PAT }}
          CODEXCTL_SLOT:           ${{ needs.create-ai-repair.outputs.slot }}
          CODEXCTL_PREFLIGHT:      1
          CODEXCTL_WAIT:           1
          CODEXCTL_ONLY_INFRA:     namespace-and-config,codex-ai-repair-rbac
          CODEXCTL_ONLY_SERVICES:  codex
          OPENAI_API_KEY:          ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:        ${{ secrets.CONTEXT7_API_KEY }}
          POSTGRES_USER:           ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD:       ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD:          ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY:              ${{ secrets.SECRET_KEY }}
        run: |
          set -euo pipefail
          codexctl ci apply

      - name: "Cleanup staging repair env on failure üßπ"
        if: failure() || cancelled()
        env:
          CODEXCTL_SLOT: ${{ needs.create-ai-repair.outputs.slot }}
          CODEXCTL_WITH_CONFIGMAP: 1
        run: |
          set -euo pipefail
          codexctl manage-env cleanup || true

  run-codex:
    needs: [create-ai-repair, deploy-ai-repair]
    name: "Run staging repair agent ü§ñ"
    runs-on: self-hosted
    environment: staging
    env:
      CODEXCTL_GH_PAT:   ${{ secrets.CODEXCTL_GH_PAT }}
    steps:
      - name: "Checkout default branch üì•"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEXCTL_GH_PAT }}

      - name: "Sync staging sources üìÇ"
        run: |
          set -euo pipefail
          codexctl ci sync-sources

      - name: "Ensure working branch üåø"
        env:
          CODEXCTL_ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          WORKDIR="${CODEXCTL_CODE_ROOT_BASE}/staging/src"
          cd "${WORKDIR}"
          git config user.name "${CODEXCTL_GH_USERNAME}"
          git config user.email "${CODEXCTL_GH_EMAIL}"
          git checkout -b "codex/ai-repair-${CODEXCTL_ISSUE_NUMBER}" || git checkout "codex/ai-repair-${CODEXCTL_ISSUE_NUMBER}"
        shell: bash

      - name: "Run Codex staging repair agent ü§ñ"
        env:
          GITHUB_RUN_ID:           ${{ github.run_id }}
          CODEXCTL_GH_PAT:         ${{ secrets.CODEXCTL_GH_PAT }}
          CODEXCTL_SLOT:           ${{ needs.create-ai-repair.outputs.slot }}
          CODEXCTL_NAMESPACE:      ${{ needs.create-ai-repair.outputs.namespace }}
          CODEXCTL_ISSUE_NUMBER:   ${{ github.event.issue.number }}
          OPENAI_API_KEY:          ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:        ${{ secrets.CONTEXT7_API_KEY }}
        run: |
          set -euo pipefail
          codexctl prompt run --kind ai-repair_issue

      - name: "Cleanup staging repair env on failure üßπ"
        if: failure() || cancelled()
        env:
          CODEXCTL_SLOT: ${{ needs.create-ai-repair.outputs.slot }}
          CODEXCTL_WITH_CONFIGMAP: 1
        run: |
          set -euo pipefail
          if [ -z "${CODEXCTL_SLOT}" ]; then
            exit 0
          fi
          codexctl manage-env cleanup || true

      - name: "Auto-commit and push changes üì§"
        env:
          CODEXCTL_ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          WORKDIR="${CODEXCTL_CODE_ROOT_BASE}/staging/src"
          cd "${WORKDIR}"

          BRANCH="codex/ai-repair-${CODEXCTL_ISSUE_NUMBER}"
          if git rev-parse --verify "$BRANCH" >/dev/null 2>&1; then
            git checkout "$BRANCH"
          fi

          rm -rf .bin || true

          git add -u
          git add docs proto services libs || true

          if git diff --cached --quiet; then
            echo "no changes to commit"
            exit 0
          fi

          MSG="fix: staging repair for issue #${CODEXCTL_ISSUE_NUMBER}"
          git commit -m "$MSG"
          git push origin "$BRANCH"

      - name: "Detect PR for issue branch üîé"
        id: detect_pr
        env:
          CODEXCTL_ISSUE_NUMBER: ${{ github.event.issue.number }}
          CODEXCTL_GH_PAT: ${{ secrets.CODEXCTL_GH_PAT }}
        run: |
          set -euo pipefail
          BRANCH="codex/ai-repair-${CODEXCTL_ISSUE_NUMBER}"
          WORKDIR="${CODEXCTL_CODE_ROOT_BASE}/staging/src"
          cd "${WORKDIR}"

          printf '%s' "${CODEXCTL_GH_PAT}" | gh auth login --with-token >/dev/null 2>&1 || true

          PRN="$(gh pr list --head "${BRANCH}" --json number -q '.[0].number' 2>/dev/null || true)"
          if [ -z "${PRN}" ]; then
            echo "warn: PR not found for branch ${BRANCH}" >&2
            exit 0
          fi

          echo "codexctl_pr_number=${PRN}" >> "$GITHUB_OUTPUT"

      - name: "Attach PR number to slot üè∑Ô∏è"
        if: steps.detect_pr.outputs.codexctl_pr_number != ''
        env:
          CODEXCTL_SLOT:     ${{ needs.create-ai-repair.outputs.slot }}
          CODEXCTL_PR_NUMBER: ${{ steps.detect_pr.outputs.codexctl_pr_number }}
        run: |
          set -euo pipefail
          codexctl manage-env set

      - name: "Comment to PR with env links üîó"
        if: steps.detect_pr.outputs.codexctl_pr_number != ''
        env:
          CODEXCTL_SLOT:      ${{ needs.create-ai-repair.outputs.slot }}
          CODEXCTL_PR_NUMBER: ${{ steps.detect_pr.outputs.codexctl_pr_number }}
          CODEXCTL_GH_PAT:    ${{ secrets.CODEXCTL_GH_PAT }}
        run: |
          set -euo pipefail
          codexctl manage-env comment-pr || true
