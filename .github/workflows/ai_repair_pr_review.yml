name: "Staging Repair PR Review ðŸ‘"

on:
  pull_request_review:
    types: [submitted]

env:
  CODEXCTL_ALLOWED_USERS:  ${{ vars.CODEXCTL_ALLOWED_USERS }}
  CODEXCTL_GH_USERNAME:    ${{ vars.CODEXCTL_GH_USERNAME }}
  CODEXCTL_ENV:            ai-repair
  CODEXCTL_LANG:           ${{ vars.CODEXCTL_LANG }}
  CODEXCTL_DEV_SLOTS_MAX:  ${{ vars.CODEXCTL_DEV_SLOTS_MAX }}
  CODEXCTL_CODE_ROOT_BASE: ${{ vars.CODEXCTL_CODE_ROOT_BASE }}
  CODEXCTL_DATA_ROOT:      ${{ vars.CODEXCTL_DATA_ROOT }}
  CODEXCTL_WORKSPACE_UID:  ${{ vars.CODEXCTL_WORKSPACE_UID }}
  CODEXCTL_WORKSPACE_GID:  ${{ vars.CODEXCTL_WORKSPACE_GID }}

concurrency:
  group: ai-repair-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  run:
    name: "Staging repair review run ðŸ¤–"
    if: >-
      github.event.review.state == 'changes_requested' &&
      startsWith(github.event.pull_request.head.ref, 'codex/ai-repair-') &&
      contains(format(',{0},', vars.CODEXCTL_ALLOWED_USERS), format(',{0},', github.actor))
    runs-on: self-hosted
    environment: staging
    env:
      CODEXCTL_GH_PAT:         ${{ secrets.CODEXCTL_GH_PAT }}
      GITHUB_RUN_ID:        ${{ github.run_id }}
      KUBECONFIG:           /home/runner/.kube/microk8s.config
      OPENAI_API_KEY:       ${{ secrets.OPENAI_API_KEY }}
      CONTEXT7_API_KEY:     ${{ secrets.CONTEXT7_API_KEY }}
      POSTGRES_USER:        ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD:    ${{ secrets.POSTGRES_PASSWORD }}
      REDIS_PASSWORD:       ${{ secrets.REDIS_PASSWORD }}
      SECRET_KEY:           ${{ secrets.SECRET_KEY }}
    steps:
      - name: "Checkout PR head ðŸ“¥"
        uses: actions/checkout@v4
        with:
          ref:   ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.CODEXCTL_GH_PAT }}
          fetch-depth: 0

      - name: "Sync staging sources ðŸ“‚"
        run: |
          set -euo pipefail
          if [ -z "${CODEXCTL_CODE_ROOT_BASE:-}" ]; then
            echo "error: CODEXCTL_CODE_ROOT_BASE is not set" >&2
            exit 1
          fi
          STAGING_SRC="${CODEXCTL_CODE_ROOT_BASE}/staging/src"
          mkdir -p "${STAGING_SRC}"
          rsync -a --delete --exclude '.cache' ./ "${STAGING_SRC}/"

      - name: "Resolve slot and namespace for PR ðŸ“‡"
        id: card
        env:
          CODEXCTL_PR_NUMBER:     ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          codexctl ci ensure-slot

      - name: "Compute env flags ðŸ§®"
        id: env_state
        env:
          CODEXCTL_SLOT: ${{ steps.card.outputs.slot }}
          CODEXCTL_NAMESPACE: ${{ steps.card.outputs.namespace }}
          CODEXCTL_PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          if [ -z "${CODEXCTL_SLOT:-}" ] || [ -z "${CODEXCTL_NAMESPACE:-}" ]; then
            echo "error: cannot resolve slot/ns for PR ${CODEXCTL_PR_NUMBER}" >&2
            exit 1
          fi
          NEW_ENV="false"
          if ! kubectl get ns "${CODEXCTL_NAMESPACE}" >/dev/null 2>&1; then
            NEW_ENV="true"
          elif ! kubectl -n "${CODEXCTL_NAMESPACE}" get deploy codex >/dev/null 2>&1; then
            NEW_ENV="true"
          fi
          echo "NEW_ENV=$NEW_ENV" >> "$GITHUB_OUTPUT"

      - name: "Ensure staging repair env via codexctl ðŸš€"
        env:
          GITHUB_RUN_ID:           ${{ github.run_id }}
          CODEXCTL_GH_PAT:         ${{ secrets.CODEXCTL_GH_PAT }}
          CODEXCTL_SLOT:           ${{ steps.card.outputs.slot }}
          CODEXCTL_PREFLIGHT:      true
          CODEXCTL_WAIT:           true
          CODEXCTL_ONLY_INFRA:     namespace-and-config,codex-ai-repair-rbac
          CODEXCTL_ONLY_SERVICES:  codex
          OPENAI_API_KEY:          ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:        ${{ secrets.CONTEXT7_API_KEY }}
          POSTGRES_USER:           ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD:       ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD:          ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY:              ${{ secrets.SECRET_KEY }}
        run: |
          set -euo pipefail
          codexctl ci apply

      - name: "Run Codex staging repair review ðŸ¤–"
        env:
          GITHUB_RUN_ID:           ${{ github.run_id }}
          CODEXCTL_GH_PAT:         ${{ secrets.CODEXCTL_GH_PAT }}
          CODEXCTL_SLOT:           ${{ steps.card.outputs.slot }}
          CODEXCTL_NAMESPACE:      ${{ steps.card.outputs.namespace }}
          CODEXCTL_PR_NUMBER:      ${{ github.event.pull_request.number }}
          OPENAI_API_KEY:          ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:        ${{ secrets.CONTEXT7_API_KEY }}
        run: |
          set -euo pipefail
          NEW_ENV="${{ steps.env_state.outputs.NEW_ENV }}"
          if [ "${NEW_ENV}" = "true" ]; then
            export CODEXCTL_PROMPT_CONTINUATION=1
            export CODEXCTL_PROMPT_MODE=full
          else
            export CODEXCTL_RESUME=true
          fi
          codexctl prompt run --kind ai-repair_review

      - name: "Apply review changes and comment ðŸ’¾"
        env:
          CODEXCTL_SLOT:      ${{ steps.card.outputs.slot }}
          CODEXCTL_PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY:  ${{ github.repository }}
          CODEXCTL_GH_PAT:    ${{ secrets.CODEXCTL_GH_PAT }}
        run: |
          set -euo pipefail
          codexctl pr review-apply

      - name: "Cleanup staging repair env on failure ðŸ§¹"
        if: (failure() || cancelled()) && steps.card.outputs.slot != ''
        env:
          CODEXCTL_SLOT: ${{ steps.card.outputs.slot }}
          CODEXCTL_WITH_CONFIGMAP: true
        run: |
          set -euo pipefail
          codexctl manage-env cleanup || true
