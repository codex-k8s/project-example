name: "Staging Repair ðŸ§¯"

on:
  issues:
    types: [labeled]

env:
  AI_ALLOWED_USERS: ${{ vars.AI_ALLOWED_USERS }}
  CODEX_GH_USERNAME: ${{ vars.CODEX_GH_USERNAME }}

concurrency:
  group: staging-repair-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  create-staging-repair:
    name: "Allocate slot ðŸ§©"
    if: >-
      github.event.label.name == '[staging-repair]' &&
      contains(format(',{0},', vars.AI_ALLOWED_USERS), format(',{0},', github.actor))
    runs-on: self-hosted
    timeout-minutes: 360
    environment: staging
    outputs:
      slot: ${{ steps.alloc.outputs.slot }}
      namespace: ${{ steps.alloc.outputs.namespace }}
    steps:
      - name: "Checkout project-example ðŸ“¥"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Allocate slot via codexctl ðŸ§©"
        id: alloc
        env:
          GITHUB_RUN_ID:     ${{ github.run_id }}
          CODEX_GH_PAT:      ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME: ${{ vars.CODEX_GH_USERNAME }}
        run: |
          set -euo pipefail
          codexctl --help >/dev/null
          ENV_NAME="staging_repair"
          ISSUE="${{ github.event.issue.number }}"
          MAX="${{ vars.DEV_SLOTS_MAX }}"

          ARGS=(ci ensure-slot --env "${ENV_NAME}" --issue "${ISSUE}" --output kv)
          if [ -n "$MAX" ]; then
            ARGS+=(--max "$MAX")
          fi

          OUT="$(codexctl "${ARGS[@]}")"
          echo "$OUT"
          SLOT=""
          NS=""
          while IFS='=' read -r key value; do
            case "$key" in
              slot) SLOT="$value" ;;
              namespace) NS="$value" ;;
            esac
          done < <(printf '%s\n' "$OUT" | sed -n 's/^\([a-zA-Z0-9_]\+\)=\(.*\)$/\1=\2/p')
          if [ -z "$SLOT" ] || [ "$SLOT" = "0" ]; then
            echo "error: failed to parse slot from codexctl output" >&2
            exit 1
          fi
          echo "slot=$SLOT" >> "$GITHUB_OUTPUT"
          echo "namespace=$NS" >> "$GITHUB_OUTPUT"

  deploy-staging-repair:
    needs: [create-staging-repair]
    name: "Deploy staging repair env ðŸš€"
    runs-on: self-hosted
    environment: staging
    steps:
      - name: "Checkout project-example ðŸ“¥"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Sync staging sources ðŸ“‚"
        env:
          CODE_ROOT_BASE: ${{ vars.CODE_ROOT_BASE }}
        run: |
          set -euo pipefail
          if [ -z "${CODE_ROOT_BASE:-}" ]; then
            echo "error: CODE_ROOT_BASE is not set" >&2
            exit 1
          fi
          STAGING_SRC="${CODE_ROOT_BASE}/staging/src"
          mkdir -p "${STAGING_SRC}"
          rsync -a --delete --exclude '.cache' ./ "${STAGING_SRC}/"

      - name: "Ensure staging repair env via codexctl ðŸš€"
        env:
          GITHUB_RUN_ID:        ${{ github.run_id }}
          CODEX_GH_PAT:         ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME:    ${{ vars.CODEX_GH_USERNAME }}
          OPENAI_API_KEY:       ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:     ${{ secrets.CONTEXT7_API_KEY }}
          CODE_ROOT_BASE:       ${{ vars.CODE_ROOT_BASE }}
          DATA_ROOT:            ${{ vars.DATA_ROOT }}
          POSTGRES_USER:        ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD:    ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD:       ${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY:           ${{ secrets.SECRET_KEY }}
        run: |
          set -euo pipefail
          codexctl --help >/dev/null
          SLOT="${{ needs.create-staging-repair.outputs.slot }}"
          export CODEX_WORKSPACE_UID="$(id -u)"
          export CODEX_WORKSPACE_GID="$(id -g)"
          codexctl ci apply \
            --env staging_repair \
            --slot "${SLOT}" \
            --preflight \
            --wait \
            --only-infra namespace-and-config,codex-staging-repair-rbac \
            --only-services codex

      - name: "Cleanup staging repair env on failure ðŸ§¹"
        if: failure() || cancelled()
        env:
          SLOT: ${{ needs.create-staging-repair.outputs.slot }}
        run: |
          set -euo pipefail
          codexctl manage-env cleanup --env staging_repair --slot "${SLOT}" --with-configmap || true

  run-codex:
    needs: [create-staging-repair, deploy-staging-repair]
    name: "Run staging repair agent ðŸ¤–"
    runs-on: self-hosted
    environment: staging
    env:
      CODE_ROOT_BASE: ${{ vars.CODE_ROOT_BASE }}
      CODEX_GH_PAT:   ${{ secrets.CODEX_GH_PAT }}
    steps:
      - name: "Checkout default branch ðŸ“¥"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: "Sync staging sources ðŸ“‚"
        env:
          CODE_ROOT_BASE: ${{ vars.CODE_ROOT_BASE }}
        run: |
          set -euo pipefail
          if [ -z "${CODE_ROOT_BASE:-}" ]; then
            echo "error: CODE_ROOT_BASE is not set" >&2
            exit 1
          fi
          STAGING_SRC="${CODE_ROOT_BASE}/staging/src"
          mkdir -p "${STAGING_SRC}"
          rsync -a --delete --exclude '.cache' ./ "${STAGING_SRC}/"

      - name: "Ensure working branch ðŸŒ¿"
        run: |
          set -euo pipefail
          codexctl --help >/dev/null
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          WORKDIR="${CODE_ROOT_BASE}/staging/src"
          cd "${WORKDIR}"
          git config user.name "codex-bot"
          git config user.email "codex-bot@example.com"
          git checkout -b "codex/staging-repair-${ISSUE_NUMBER}" || git checkout "codex/staging-repair-${ISSUE_NUMBER}"
        shell: bash

      - name: "Run Codex staging repair agent ðŸ¤–"
        env:
          GITHUB_RUN_ID:     ${{ github.run_id }}
          CODEX_GH_PAT:      ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME: ${{ vars.CODEX_GH_USERNAME }}
          OPENAI_API_KEY:    ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY:  ${{ secrets.CONTEXT7_API_KEY }}
        run: |
          set -euo pipefail
          codexctl --help >/dev/null
          SLOT="${{ needs.create-staging-repair.outputs.slot }}"
          NS="${{ needs.create-staging-repair.outputs.namespace }}"
          ISSUE="${{ github.event.issue.number }}"
          ARGS=(prompt run --env staging_repair --slot "${SLOT}" --kind staging_repair_issue --lang ru)
          if [ -n "$NS" ]; then
            ARGS+=(--namespace "$NS")
          fi
          if [ -n "$ISSUE" ]; then
            ARGS+=(--issue "$ISSUE")
          fi
          codexctl "${ARGS[@]}"

      - name: "Cleanup staging repair env on failure ðŸ§¹"
        if: failure() || cancelled()
        env:
          SLOT: ${{ needs.create-staging-repair.outputs.slot }}
        run: |
          set -euo pipefail
          if [ -z "${SLOT}" ]; then
            exit 0
          fi
          codexctl manage-env cleanup --env staging_repair --slot "${SLOT}" --with-configmap || true

      - name: "Auto-commit and push changes ðŸ“¤"
        env:
          ISSUE: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          codexctl --help >/dev/null
          WORKDIR="${CODE_ROOT_BASE}/staging/src"
          cd "${WORKDIR}"

          BRANCH="codex/staging-repair-${ISSUE}"
          if git rev-parse --verify "$BRANCH" >/dev/null 2>&1; then
            git checkout "$BRANCH"
          fi

          rm -rf .bin || true

          git add -u
          git add docs proto services libs || true

          if git diff --cached --quiet; then
            echo "no changes to commit"
            exit 0
          fi

          MSG="fix: staging repair for issue #${ISSUE}"
          git commit -m "$MSG"
          git push origin "$BRANCH"

      - name: "Detect PR for issue branch ðŸ”Ž"
        id: detect_pr
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          CODEX_GH_PAT: ${{ secrets.CODEX_GH_PAT }}
        run: |
          set -euo pipefail
          codexctl --help >/dev/null
          BRANCH="codex/staging-repair-${ISSUE_NUMBER}"
          WORKDIR="${CODE_ROOT_BASE}/staging/src"
          cd "${WORKDIR}"

          printf '%s' "${CODEX_GH_PAT}" | gh auth login --with-token >/dev/null 2>&1 || true

          PRN="$(gh pr list --head "${BRANCH}" --json number -q '.[0].number' 2>/dev/null || true)"
          if [ -z "${PRN}" ]; then
            echo "warn: PR not found for branch ${BRANCH}" >&2
            exit 0
          fi

          echo "PR_NUMBER=${PRN}" >> "$GITHUB_OUTPUT"

      - name: "Attach PR number to slot ðŸ·ï¸"
        if: steps.detect_pr.outputs.PR_NUMBER != ''
        env:
          SLOT: ${{ needs.create-staging-repair.outputs.slot }}
          PR_NUMBER: ${{ steps.detect_pr.outputs.PR_NUMBER }}
        run: |
          set -euo pipefail
          codexctl --help >/dev/null
          codexctl manage-env set --env staging_repair --slot "${SLOT}" --pr "${PR_NUMBER}"

      - name: "Comment to PR with env links ðŸ”—"
        if: steps.detect_pr.outputs.PR_NUMBER != ''
        env:
          SLOT: ${{ needs.create-staging-repair.outputs.slot }}
          PR_NUMBER: ${{ steps.detect_pr.outputs.PR_NUMBER }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          CODEX_GH_PAT: ${{ secrets.CODEX_GH_PAT }}
        run: |
          set -euo pipefail
          codexctl --help >/dev/null
          BODY_FILE="$(mktemp)"
          codexctl manage-env comment --env staging_repair --slot "${SLOT}" --lang ru > "${BODY_FILE}"
          printf '%s' "${CODEX_GH_PAT}" | gh auth login --with-token >/dev/null 2>&1 || true
          gh pr comment "${PR_NUMBER}" --repo "${GITHUB_REPOSITORY}" --body-file "${BODY_FILE}" || true
