{{- $registryHost := envOr "CODEXCTL_REGISTRY_HOST" (printf "registry.%s.svc.cluster.local:5000" .Namespace) -}}
{{- $tagEnv := ternary (or (eq .Env "ai") (eq .Env "ai-repair")) "ai-staging" .Env -}}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: yaml-mcp-github-review
  namespace: codex-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: yaml-mcp-github-review
  namespace: codex-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: yaml-mcp-github-review
  template:
    metadata:
      labels:
        app: yaml-mcp-github-review
    spec:
      serviceAccountName: yaml-mcp-github-review
      containers:
        - name: yaml-mcp-github-review
          image: {{ $registryHost }}/project-example/platform/yaml-mcp-server-github-review:{{ $tagEnv }}-{{ index .Versions "yaml-mcp-server" }}
          imagePullPolicy: Always
          args: ["--embedded-config", "github_review.yaml"]
          ports:
            - name: http
              containerPort: 8080
          env:
            - name: YAML_MCP_HTTP_HOST
              value: '{{ envOr "YAML_MCP_HTTP_HOST" "0.0.0.0" }}'
            - name: YAML_MCP_HTTP_PORT
              value: '{{ envOr "YAML_MCP_HTTP_PORT" "8080" }}'
            - name: YAML_MCP_SERVICE_HOST
              value: '{{ printf "%s.%s.svc.cluster.local" "yaml-mcp-github-review" "codex-system" }}'
            - name: YAML_MCP_SERVICE_PORT
              value: "8080"
            - name: YAML_MCP_LANG
              value: '{{ envOr "YAML_MCP_REVIEW_LANG" "ru" }}'
            - name: YAML_MCP_LOG_LEVEL
              value: '{{ envOr "YAML_MCP_REVIEW_LOG_LEVEL" "info" }}'
            - name: YAML_MCP_GITHUB_REPO
              value: '{{ envOr "YAML_MCP_REVIEW_GITHUB_REPO" (envOr "CODEXCTL_REPO" "") }}'
            - name: YAML_MCP_GH_USERNAME
              value: '{{ envOr "YAML_MCP_REVIEW_GH_USERNAME" "" }}'
            - name: YAML_MCP_GH_PAT
              valueFrom:
                secretKeyRef:
                  name: yaml-mcp-github-review-secrets
                  key: YAML_MCP_GH_PAT
          readinessProbe:
            httpGet:
              path: /readyz
              port: http
            initialDelaySeconds: 2
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
