# {{- $codeRootBase := envOr "CODE_ROOT_BASE" "" -}}
# {{- $slotCodeRoot := default (printf "%s/slots" .ProjectRoot) $codeRootBase -}}
# {{- $stagingCodeRoot := default .ProjectRoot (ternary (ne $codeRootBase "") (printf "%s/staging/src" $codeRootBase) "") -}}
# {{- $dataRoot := default (envOr "DATA_ROOT" "") (printf "%s/.data" .ProjectRoot) -}}
project: project-example

codex:
  model: "gpt-5.2-codex"
  modelReasoningEffort: "medium"
  promptLang: "ru"
  extraTools:
    - psql
    - redis-cli
    - go
    - node
  links:
    - title: Chat frontend
      path: /
    - title: Django admin
      path: /admin/
  projectContext: |
    - Перед началом работы прочитай ./AGENTS.md и релевантную документацию в docs/*.md.
    - Для проверки используй kubectl (логи и статусы pod’ов/деплойментов) и HTTP‑эндпоинты сервисов (frontend, Go API, Django admin).
    - Для работы с манифестами используй `codexctl render` и `codexctl apply` только с фильтрами `--only-services/--only-infra` (или `--skip-*`); не запускай apply без фильтров и не включай сервис `codex`.
  servicesOverview: |
    - Django backend: админка и миграции БД PostgreSQL.
    - Go chat backend: HTTP API чата, авторизация, работа с PostgreSQL и Redis.
    - Web frontend (Vue3 + Pinia): одностраничный интерфейс для регистрации, логина и общения в общем чате.
  timeouts:
    exec: "60m"
    rollout: "30m"
    deployWait: "10m"

namespace:
  patterns:
    dev: "{{ .Project }}-dev"
    staging: "{{ .Project }}-staging"
    ai: "{{ .Project }}-dev-{{ .Slot }}"
    staging_repair: "{{ .Project }}-staging-repair-{{ .Slot }}"

maxSlots: 0

registry: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}'

baseDomain:
  dev: '{{ envOr "BASE_DOMAIN_DEV" "dev.example-domain.ru" }}'
  staging: '{{ envOr "BASE_DOMAIN_STAGING" "staging.example-domain.ru" }}'
  ai: '{{ envOr "BASE_DOMAIN_AI" (envOr "BASE_DOMAIN_STAGING" "staging.example-domain.ru") }}'
  staging_repair: '{{ envOr "BASE_DOMAIN_STAGING" "staging.example-domain.ru" }}'

dataPaths:
  root: '{{ $dataRoot }}'
  envDir: '{{ ternary (eq .Env "ai") (printf "%s/slots/%d" $dataRoot .Slot) (printf "%s/%s" $dataRoot .Env) }}'
  dirs:
    - postgres
    - redis

state:
  backend: configmap
  configmapNamespace: codex-system
  configmapPrefix: codex-env-

versions:
  django-backend: "0.1.1"
  chat-backend: "0.1.2"
  web-frontend: "0.1.2"
  codex: "0.1.0"
  codexctl: "latest"
  busybox: "1.37.0"
  http-echo: "0.2.3"
  postgres-image: "16-bookworm"
  redis-image: "7-bookworm"
  jaeger: "2.11.0"
  node: "22-bookworm"
  python: "3.13-bookworm"
  python-slim: "3.13-slim"
  golang: "1.25.1-bookworm"
  debian-slim: "bookworm-slim"
  kubectl: "v1.34.1"
  protoc: "32.1"

images:
  busybox:
    type: external
    from: 'docker.io/library/busybox:{{ index .Versions "busybox" }}'
    local: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/library/busybox:{{ index .Versions "busybox" }}'
  postgres:
    type: external
    from: 'docker.io/library/postgres:{{ index .Versions "postgres-image" }}'
    local: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/library/postgres:{{ index .Versions "postgres-image" }}'
  redis:
    type: external
    from: 'docker.io/library/redis:{{ index .Versions "redis-image" }}'
    local: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/library/redis:{{ index .Versions "redis-image" }}'
  jaeger:
    type: external
    from: 'docker.io/jaegertracing/jaeger:{{ index .Versions "jaeger" }}'
    local: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/library/jaeger:{{ index .Versions "jaeger" }}'

  django-backend:
    type: build
    repository: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/project-example/django-backend'
    tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "staging" .Env) (index .Versions "django-backend") }}'
    dockerfile: 'services/django_backend/Dockerfile'
    context: 'services/django_backend'
    buildArgs:
      PYTHON_IMAGE_VERSION: '{{ index .Versions "python" }}'
      SERVICE_VERSION: '{{ index .Versions "django-backend" }}'

  chat-backend:
    type: build
    repository: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/project-example/chat-backend'
    tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "staging" .Env) (index .Versions "chat-backend") }}'
    dockerfile: 'services/chat_backend/Dockerfile'
    context: 'services/chat_backend'
    buildArgs:
      GOLANG_IMAGE_VERSION: '{{ index .Versions "golang" }}'
      SERVICE_VERSION: '{{ index .Versions "chat-backend" }}'

  web-frontend:
    type: build
    repository: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/project-example/web-frontend'
    tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "staging" .Env) (index .Versions "web-frontend") }}'
    dockerfile: 'services/web_frontend/Dockerfile'
    context: 'services/web_frontend'
    buildArgs:
      NODE_IMAGE_VERSION: '{{ index .Versions "node" }}'
      SERVICE_VERSION: '{{ index .Versions "web-frontend" }}'

  codex:
    type: build
    repository: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/project-example/codex'
    tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "staging" .Env) (index .Versions "codex") }}'
    dockerfile: 'deploy/codex/Dockerfile'
    context: '.'
    buildArgs:
      NODE_IMAGE_VERSION: '{{ index .Versions "node" }}'
      KUBECTL_VERSION: '{{ index .Versions "kubectl" }}'
      PROTOC_VERSION: '{{ index .Versions "protoc" }}'
      CODEX_IMAGE_VERSION: '{{ index .Versions "codex" }}'
      CODEXCTL_VERSION: '{{ index .Versions "codexctl" }}'

environments:
  dev:
    kubeconfig: "/home/user/.kube/project-example-dev"
    imagePullPolicy: IfNotPresent
    localRegistry:
      enabled: true
      name: "project-example-registry"
      port: 32000
  staging:
    kubeconfig: "/home/runner/.kube/microk8s.config"
    imagePullPolicy: Always
    localRegistry:
      enabled: true
      name: "project-example-registry"
      port: 32000
  ai:
    from: "staging"
    imagePullPolicy: IfNotPresent
  staging_repair:
    from: "staging"
    imagePullPolicy: IfNotPresent

hooks:
  beforeAll:
    - name: ensure-local-data-dirs
      when: '{{ or (eq .Env "dev") (eq .Env "staging") (eq .Env "ai") }}'
      use: codex.ensure-data-dirs

infrastructure:
  - name: namespace-and-config
    when: '{{ or (eq .Env "dev") (eq .Env "staging") (eq .Env "ai") (eq .Env "staging_repair") }}'
    manifests:
      - path: deploy/namespace.yaml
      - path: deploy/configmap.yaml
      - path: deploy/secret.yaml

  - name: cluster-dns
    when: '{{ eq .Env "staging" }}'
    manifests:
      - path: deploy/dns.configmap.yaml

  - name: codex-staging-repair-rbac
    when: '{{ eq .Env "staging_repair" }}'
    manifests:
      - path: deploy/codex/rbac-staging-repair.yaml

  - name: tls-issuer
    when: '{{ or (eq .Env "dev") (eq .Env "staging") (eq .Env "ai") }}'
    manifests:
      - path: deploy/cluster-issuer.yaml

  - name: echo-probe
    when: '{{ eq .Env "staging" }}'
    manifests:
      - path: deploy/echo-probe.yaml
    hooks:
      afterApply:
        - name: wait-echo-probe
          when: '{{ eq .Env "staging" }}'
          run: |
            set -euo pipefail
            NS="{{ .Namespace }}"
            if [ -z "${NS}" ]; then
              NS="{{ .Project }}-staging"
            fi
            echo "Waiting for echo-probe in namespace ${NS}..." >&2
            kubectl -n "${NS}" rollout status deploy/echo-probe --timeout=120s
        - name: check-echo-probe-http
          when: '{{ eq .Env "staging" }}'
          run: |
            set -euo pipefail
            HOST="{{ index .BaseDomain "staging" }}"
            if ! nc -z 127.0.0.1 80; then
              echo "error: port 80 is not reachable on localhost" >&2
              exit 1
            fi
            if ! nc -z 127.0.0.1 443; then
              echo "error: port 443 is not reachable on localhost" >&2
              exit 1
            fi
            ok=0
            for i in {1..30}; do
              if curl -sSL --max-time 5 -H "Host: ${HOST}" http://127.0.0.1/_probe | grep -q "ok"; then
                ok=1; break
              fi
              sleep 2
            done
            if [ "$ok" -ne 1 ]; then
              echo "error: echo-probe HTTP check failed" >&2
              exit 1
            fi
        - name: cleanup-echo-probe
          when: '{{ eq .Env "staging" }}'
          run: |
            set -euo pipefail
            NS="{{ .Namespace }}"
            if [ -z "${NS}" ]; then
              NS="{{ .Project }}-staging"
            fi
            kubectl -n "${NS}" delete deploy/echo-probe svc/echo-probe ingress/echo-probe --ignore-not-found || true

  - name: data-services
    when: '{{ or (eq .Env "dev") (eq .Env "staging") (eq .Env "ai") }}'
    manifests:
      - path: deploy/postgres.service.yaml
      - path: deploy/redis.service.yaml

  - name: observability
    when: '{{ or (eq .Env "dev") (eq .Env "staging") (eq .Env "ai") }}'
    manifests:
      - path: deploy/jaeger.yaml

services:
  - name: django-backend
    manifests:
      - path: services/django_backend/deploy.yaml
    image:
      repository: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/project-example/django-backend'
      tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "staging" .Env) (index .Versions "django-backend") }}'
    when: '{{ or (eq .Env "dev") (eq .Env "staging") (eq .Env "ai") }}'
    overlays:
      dev:
        hostMounts:
          - name: django-src
            hostPath: "{{ .ProjectRoot }}/services/django_backend"
            mountPath: "/backend"
      staging:
        hostMounts:
          - name: django-src
            hostPath: '{{ printf "%s/services/django_backend" $stagingCodeRoot }}'
            mountPath: "/backend"
      ai:
        hostMounts:
          - name: django-src
            hostPath: '{{ printf "%s/%d/src/services/django_backend" $slotCodeRoot .Slot }}'
            mountPath: "/backend"
        dropKinds: ["Ingress"]

  - name: chat-backend
    manifests:
      - path: services/chat_backend/deploy.yaml
    image:
      repository: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/project-example/chat-backend'
      tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "staging" .Env) (index .Versions "chat-backend") }}'
    when: '{{ or (eq .Env "dev") (eq .Env "staging") (eq .Env "ai") }}'
    overlays:
      dev:
        hostMounts:
          - name: go-src
            hostPath: "{{ .ProjectRoot }}/services/chat_backend"
            mountPath: "/app"
      staging:
        hostMounts:
          - name: go-src
            hostPath: '{{ printf "%s/services/chat_backend" $stagingCodeRoot }}'
            mountPath: "/app"
      ai:
        hostMounts:
          - name: go-src
            hostPath: '{{ printf "%s/%d/src/services/chat_backend" $slotCodeRoot .Slot }}'
            mountPath: "/app"
        dropKinds: ["Ingress"]

  - name: web-frontend
    manifests:
      - path: services/web_frontend/deploy.yaml
    image:
      repository: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/project-example/web-frontend'
      tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "staging" .Env) (index .Versions "web-frontend") }}'
    when: '{{ or (eq .Env "dev") (eq .Env "staging") (eq .Env "ai") }}'
    overlays:
      dev:
        hostMounts:
          - name: web-src
            hostPath: "{{ .ProjectRoot }}/services/web_frontend"
            mountPath: "/app"
      staging:
        hostMounts:
          - name: web-src
            hostPath: '{{ printf "%s/services/web_frontend" $stagingCodeRoot }}'
            mountPath: "/app"
      ai:
        hostMounts:
          - name: web-src
            hostPath: '{{ printf "%s/%d/src/services/web_frontend" $slotCodeRoot .Slot }}'
            mountPath: "/app"
        dropKinds: ["Ingress"]

  - name: codex
    manifests:
      - path: deploy/codex/rbac.yaml
      - path: deploy/codex/codex-deploy.yaml
      - path: deploy/codex/ingress-dev.yaml
    image:
      repository: '{{ envOr "REGISTRY_HOST" "localhost:32000" }}/project-example/codex'
      tagTemplate: '{{ printf "%s-%s" (ternary (or (eq .Env "ai") (eq .Env "staging_repair")) "staging" .Env) (index .Versions "codex") }}'
    when: '{{ or (eq .Env "ai") (eq .Env "staging_repair") }}'
    overlays:
      ai:
        hostMounts:
          - name: code-src
            hostPath: '{{ printf "%s/%d/src" $slotCodeRoot .Slot }}'
            mountPath: "/workspace"
      staging_repair:
        hostMounts:
          - name: code-src
            hostPath: '{{ $stagingCodeRoot }}'
            mountPath: "/workspace"
        dropKinds: ["Ingress"]
    hooks:
      afterApply:
        - name: check-dev-host-ports
          when: '{{ eq .Env "ai" }}'
          use: codex.check-dev-host-ports
        - name: reuse-dev-tls-secret
          when: '{{ eq .Env "ai" }}'
          use: codex.reuse-dev-tls-secret
