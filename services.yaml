# {{- $workspaceMount := envOr "CODEXCTL_WORKSPACE_MOUNT" "/workspace" -}}
# {{- $codeRootBase := envOr "CODEXCTL_CODE_ROOT_BASE" (printf "%s/codex/envs" $workspaceMount) -}}
# {{- $codeRootRel := trimPrefix $codeRootBase (printf "%s/" $workspaceMount) -}}
# {{- $devCodeRoot := printf "%s/dev/src" $codeRootRel -}}
# {{- $aiStagingCodeRoot := printf "%s/ai-staging/src" $codeRootRel -}}
# {{- $slotCodeRoot := $codeRootRel -}}
# {{- $workspacePVC := envOr "CODEXCTL_WORKSPACE_PVC" (printf "%s-workspace" .Project) -}}
# {{- $registryHost := envOr "CODEXCTL_REGISTRY_HOST" (printf "registry.%s.svc.cluster.local:5000" .Namespace) -}}

project: project-example

codex:
  model: "gpt-5.2-codex"
  modelReasoningEffort: "medium"
  promptLang: "ru"
  extraTools:
    - psql - работа с PostgreSQL
    - redis-cli - работа с Redis
    - go - компиляция и запуск Go-программ
    - dupl - поиск дублирующегося кода в Go-проектах
    - golangci-lint - статический анализ Go-кода
  links:
    - title: Chat web
      path: /
    - title: Gateway docs
      path: /docs
  projectContext: |
    - Перед началом работы прочитай ./AGENTS.md и релевантную документацию в docs/design-guidelines/**.
    - Для работы с манифестами используй `codexctl render` и `codexctl apply` только с фильтрами `--only-services/--only-infra` (или `--skip-*`); не запускай apply без фильтров и не включай сервис `codex`.
  servicesOverview: |
    - chat-web (Vue3): SPA интерфейс чата (логин/регистрация/сообщения).
    - chat-gateway (external, Go): REST + WebSocket, cookie-сессии, интеграция внутрь по gRPC.
    - users (internal, Go): пользователи и пароли (Postgres).
    - messages (internal, Go): сообщения (Postgres) + gRPC stream событий.
    - messages-cleaner (jobs, Go): cron-задача, удаляет сообщения старше 10 минут.
  timeouts:
    exec: "60m"
    rollout: "30m"
    deployWait: "5m"

namespace:
  patterns:
    dev: "{{ .Project }}-dev"
    ai-staging: "{{ .Project }}-ai-staging"
    ai: "{{ .Project }}-dev-{{ .Slot }}"
    ai-repair: "{{ .Project }}-ai-staging"

maxSlots: 10

registry: '{{ $registryHost }}'

storage:
  workspace:
    size: "10Gi"
    accessModes: ["ReadWriteMany"]
    storageClass: '{{ envOr "CODEXCTL_STORAGE_CLASS_WORKSPACE" "" }}'
  data:
    size: "10Gi"
    accessModes: ["ReadWriteOnce"]
    storageClass: '{{ envOr "CODEXCTL_STORAGE_CLASS_DATA" "" }}'
  registry:
    size: "20Gi"
    accessModes: ["ReadWriteOnce"]
    storageClass: '{{ envOr "CODEXCTL_STORAGE_CLASS_REGISTRY" "" }}'

baseDomain:
  dev: '{{ envOr "CODEXCTL_BASE_DOMAIN_DEV" "dev.example-domain.ru" }}'
  ai-staging: '{{ envOr "CODEXCTL_BASE_DOMAIN_AI_STAGING" "ai-staging.example-domain.ru" }}'
  ai: '{{ envOr "CODEXCTL_BASE_DOMAIN_AI" (envOr "CODEXCTL_BASE_DOMAIN_AI_STAGING" "ai-staging.example-domain.ru") }}'
  ai-repair: '{{ envOr "CODEXCTL_BASE_DOMAIN_AI_STAGING" "ai-staging.example-domain.ru" }}'

state:
  backend: configmap
  configmapNamespace: codex-system
  configmapPrefix: codex-env-

versions:
  users: "0.1.0"
  messages: "0.1.0"
  chat-gateway: "0.1.0"
  messages-cleaner: "0.1.0"
  chat-web: "0.1.0"
  codex: "0.2.2"
  codexctl: "latest"
  busybox: "1.37.0"
  http-echo: "0.2.3"
  postgres-image: "16-bookworm"
  redis-image: "7-bookworm"
  jaeger: "2.11.0"
  node: "22-bookworm"
  golang: "1.25.6-bookworm"
  debian-slim: "bookworm-slim"
  kubectl: "v1.34.1"
  protoc: "32.1"

images:
  busybox:
    type: external
    from: 'docker.io/library/busybox:{{ index .Versions "busybox" }}'
    local: '{{ $registryHost }}/library/busybox:{{ index .Versions "busybox" }}'
  postgres:
    type: external
    from: 'docker.io/library/postgres:{{ index .Versions "postgres-image" }}'
    local: '{{ $registryHost }}/library/postgres:{{ index .Versions "postgres-image" }}'
  redis:
    type: external
    from: 'docker.io/library/redis:{{ index .Versions "redis-image" }}'
    local: '{{ $registryHost }}/library/redis:{{ index .Versions "redis-image" }}'
  jaeger:
    type: external
    from: 'docker.io/jaegertracing/jaeger:{{ index .Versions "jaeger" }}'
    local: '{{ $registryHost }}/library/jaeger:{{ index .Versions "jaeger" }}'

  users:
    type: build
    repository: '{{ $registryHost }}/project-example/users'
    tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "ai-staging" .Env) (index .Versions "users") }}'
    dockerfile: 'services/internal/users/Dockerfile'
    context: '.'
    buildArgs:
      GOLANG_IMAGE_VERSION: '{{ index .Versions "golang" }}'
      SERVICE_VERSION: '{{ index .Versions "users" }}'

  messages:
    type: build
    repository: '{{ $registryHost }}/project-example/messages'
    tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "ai-staging" .Env) (index .Versions "messages") }}'
    dockerfile: 'services/internal/messages/Dockerfile'
    context: '.'
    buildArgs:
      GOLANG_IMAGE_VERSION: '{{ index .Versions "golang" }}'
      SERVICE_VERSION: '{{ index .Versions "messages" }}'

  chat-gateway:
    type: build
    repository: '{{ $registryHost }}/project-example/chat-gateway'
    tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "ai-staging" .Env) (index .Versions "chat-gateway") }}'
    dockerfile: 'services/external/chat-gateway/Dockerfile'
    context: '.'
    buildArgs:
      GOLANG_IMAGE_VERSION: '{{ index .Versions "golang" }}'
      SERVICE_VERSION: '{{ index .Versions "chat-gateway" }}'

  messages-cleaner:
    type: build
    repository: '{{ $registryHost }}/project-example/messages-cleaner'
    tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "ai-staging" .Env) (index .Versions "messages-cleaner") }}'
    dockerfile: 'services/jobs/messages-cleaner/Dockerfile'
    context: '.'
    buildArgs:
      GOLANG_IMAGE_VERSION: '{{ index .Versions "golang" }}'
      SERVICE_VERSION: '{{ index .Versions "messages-cleaner" }}'

  chat-web:
    type: build
    repository: '{{ $registryHost }}/project-example/chat-web'
    tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "ai-staging" .Env) (index .Versions "chat-web") }}'
    dockerfile: 'services/external/chat-web/Dockerfile'
    context: 'services/external/chat-web'
    buildArgs:
      NODE_IMAGE_VERSION: '{{ index .Versions "node" }}'
      SERVICE_VERSION: '{{ index .Versions "chat-web" }}'

  codex:
    type: build
    repository: '{{ $registryHost }}/project-example/codex'
    tagTemplate: '{{ printf "%s-%s" (ternary (or (eq .Env "ai") (eq .Env "ai-repair")) "ai-staging" .Env) (index .Versions "codex") }}'
    dockerfile: 'deploy/codex/Dockerfile'
    context: '.'
    buildArgs:
      NODE_IMAGE_VERSION: '{{ index .Versions "node" }}'
      KUBECTL_VERSION: '{{ index .Versions "kubectl" }}'
      PROTOC_VERSION: '{{ index .Versions "protoc" }}'
      CODEX_IMAGE_VERSION: '{{ index .Versions "codex" }}'
      CODEXCTL_VERSION: '{{ index .Versions "codexctl" }}'

environments:
  dev:
    imagePullPolicy: IfNotPresent
  ai-staging:
    imagePullPolicy: Always
  ai:
    from: "ai-staging"
    imagePullPolicy: IfNotPresent
    slotBootstrapInfra:
      - namespace-and-config
      - runner-rbac
  ai-repair:
    from: "ai-staging"
    imagePullPolicy: IfNotPresent

infrastructure:
  - name: namespace-and-config
    when: '{{ or (eq .Env "dev") (eq .Env "ai-staging") (eq .Env "ai") }}'
    manifests:
      - path: deploy/namespace.yaml
      - path: deploy/configmap.yaml
      - path: deploy/secret.yaml

  - name: runner-rbac
    when: '{{ eq .Env "ai" }}'
    manifests:
      - path: deploy/runner/rbac-ai-slots.yaml

  - name: workspace-pvc
    when: '{{ or (eq .Env "dev") (eq .Env "ai-staging") (eq .Env "ai") }}'
    manifests:
      - path: deploy/pvc-workspace.yaml

  - name: data-pvc
    when: '{{ or (eq .Env "dev") (eq .Env "ai-staging") (eq .Env "ai") }}'
    manifests:
      - path: deploy/pvc-data.yaml

  - name: registry
    when: '{{ or (eq .Env "ai-staging") (eq .Env "ai") }}'
    manifests:
      - path: deploy/registry.yaml

  - name: cluster-dns
    when: '{{ eq .Env "ai-staging" }}'
    manifests:
      - path: deploy/dns.configmap.yaml

  - name: codex-ai-repair-rbac
    when: '{{ eq .Env "ai-repair" }}'
    manifests:
      - path: deploy/codex/rbac-ai-repair.yaml

  - name: tls-issuer
    when: '{{ or (eq .Env "dev") (eq .Env "ai-staging") (eq .Env "ai") }}'
    manifests:
      - path: deploy/cluster-issuer.yaml

  - name: echo-probe
    when: '{{ eq .Env "ai-staging" }}'
    manifests:
      - path: deploy/echo-probe.yaml
    hooks:
      afterApply:
        - name: wait-echo-probe
          when: '{{ eq .Env "ai-staging" }}'
          run: |
            set -euo pipefail
            NS="{{ .Namespace }}"
            if [ -z "${NS}" ]; then
              NS="{{ .Project }}-ai-staging"
            fi
            echo "Waiting for echo-probe in namespace ${NS}..." >&2
            kubectl -n "${NS}" rollout status deploy/echo-probe --timeout=120s
        - name: check-echo-probe-http
          when: '{{ eq .Env "ai-staging" }}'
          run: |
            set -euo pipefail
            HOST="{{ index .BaseDomain "ai-staging" }}"
            if ! nc -z 127.0.0.1 80; then
              echo "error: port 80 is not reachable on localhost" >&2
              exit 1
            fi
            if ! nc -z 127.0.0.1 443; then
              echo "error: port 443 is not reachable on localhost" >&2
              exit 1
            fi
            ok=0
            for i in {1..30}; do
              if curl -sSL --max-time 5 -H "Host: ${HOST}" http://127.0.0.1/_probe | grep -q "ok"; then
                ok=1; break
              fi
              sleep 2
            done
            if [ "$ok" -ne 1 ]; then
              echo "error: echo-probe HTTP check failed" >&2
              exit 1
            fi
        - name: cleanup-echo-probe
          when: '{{ eq .Env "ai-staging" }}'
          run: |
            set -euo pipefail
            NS="{{ .Namespace }}"
            if [ -z "${NS}" ]; then
              NS="{{ .Project }}-ai-staging"
            fi
            kubectl -n "${NS}" delete deploy/echo-probe svc/echo-probe ingress/echo-probe --ignore-not-found || true

  - name: data-services
    when: '{{ or (eq .Env "dev") (eq .Env "ai-staging") (eq .Env "ai") }}'
    manifests:
      - path: deploy/postgres.service.yaml
      - path: deploy/redis.service.yaml

  - name: observability
    when: '{{ or (eq .Env "dev") (eq .Env "ai-staging") (eq .Env "ai") }}'
    manifests:
      - path: deploy/jaeger.yaml

services:
  - name: chat-web
    manifests:
      - path: services/external/chat-web/deploy.yaml
    image:
      repository: '{{ $registryHost }}/project-example/chat-web'
      tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "ai-staging" .Env) (index .Versions "chat-web") }}'
    when: '{{ or (eq .Env "dev") (eq .Env "ai-staging") (eq .Env "ai") }}'
    overlays:
      dev:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/app"
            subPath: '{{ printf "%s/services/external/chat-web" $devCodeRoot }}'
      ai-staging:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/app"
            subPath: '{{ printf "%s/services/external/chat-web" $aiStagingCodeRoot }}'
      ai:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/app"
            subPath: '{{ printf "%s/%d/src/services/external/chat-web" $slotCodeRoot .Slot }}'
        dropKinds: ["Ingress"]

  - name: chat-gateway
    manifests:
      - path: services/external/chat-gateway/deploy.yaml
    image:
      repository: '{{ $registryHost }}/project-example/chat-gateway'
      tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "ai-staging" .Env) (index .Versions "chat-gateway") }}'
    when: '{{ or (eq .Env "dev") (eq .Env "ai-staging") (eq .Env "ai") }}'
    overlays:
      dev:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ $devCodeRoot }}'
      ai-staging:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ $aiStagingCodeRoot }}'
      ai:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ printf "%s/%d/src" $slotCodeRoot .Slot }}'
        dropKinds: ["Ingress"]

  - name: users
    manifests:
      - path: services/internal/users/deploy.yaml
    image:
      repository: '{{ $registryHost }}/project-example/users'
      tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "ai-staging" .Env) (index .Versions "users") }}'
    when: '{{ or (eq .Env "dev") (eq .Env "ai-staging") (eq .Env "ai") }}'
    overlays:
      dev:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ $devCodeRoot }}'
      ai-staging:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ $aiStagingCodeRoot }}'
      ai:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ printf "%s/%d/src" $slotCodeRoot .Slot }}'

  - name: messages
    manifests:
      - path: services/internal/messages/deploy.yaml
    image:
      repository: '{{ $registryHost }}/project-example/messages'
      tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "ai-staging" .Env) (index .Versions "messages") }}'
    when: '{{ or (eq .Env "dev") (eq .Env "ai-staging") (eq .Env "ai") }}'
    overlays:
      dev:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ $devCodeRoot }}'
      ai-staging:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ $aiStagingCodeRoot }}'
      ai:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ printf "%s/%d/src" $slotCodeRoot .Slot }}'

  - name: messages-cleaner
    manifests:
      - path: services/jobs/messages-cleaner/deploy.yaml
    image:
      repository: '{{ $registryHost }}/project-example/messages-cleaner'
      tagTemplate: '{{ printf "%s-%s" (ternary (eq .Env "ai") "ai-staging" .Env) (index .Versions "messages-cleaner") }}'
    when: '{{ or (eq .Env "dev") (eq .Env "ai-staging") (eq .Env "ai") }}'
    overlays:
      dev:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ $devCodeRoot }}'
      ai-staging:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ $aiStagingCodeRoot }}'
      ai:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ printf "%s/%d/src" $slotCodeRoot .Slot }}'

  - name: codex
    manifests:
      - path: deploy/codex/rbac.yaml
      - path: deploy/codex/codex-deploy.yaml
      - path: deploy/codex/ingress-dev.yaml
    image:
      repository: '{{ $registryHost }}/project-example/codex'
      tagTemplate: '{{ printf "%s-%s" (ternary (or (eq .Env "ai") (eq .Env "ai-repair")) "ai-staging" .Env) (index .Versions "codex") }}'
    when: '{{ or (eq .Env "ai") (eq .Env "ai-repair") }}'
    overlays:
      ai:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ printf "%s/%d/src" $slotCodeRoot .Slot }}'
      ai-repair:
        pvcMounts:
          - name: workspace
            claimName: '{{ $workspacePVC }}'
            mountPath: "/workspace"
            subPath: '{{ $aiStagingCodeRoot }}'
        dropKinds: ["Ingress", "ServiceAccount", "Role", "RoleBinding"]
    hooks:
      afterApply:
        - name: reuse-dev-tls-secret
          when: '{{ eq .Env "ai" }}'
          use: codex.reuse-dev-tls-secret
